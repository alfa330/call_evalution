<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оценки операторов</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.3.1/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.3.1/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.25.6/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg:       #F5F4F1;
            --surface:  #FFFFFF;
            --border:   #E8E6E1;
            --border-2: #D4D0C8;
            --text:     #1A1814;
            --muted:    #7C7870;
            --muted-2:  #A8A49C;

            --indigo:   #3D35C8;
            --indigo-h: #2D27A8;
            --indigo-l: #EEEDFC;

            --green:    #16A07A;
            --green-l:  #E8F7F3;
            --red:      #D93535;
            --red-l:    #FDF0F0;
            --amber:    #C97A10;
            --amber-l:  #FEF6E8;

            --radius:   10px;
            --radius-sm:6px;
            --shadow:   0 1px 3px rgba(0,0,0,.07), 0 1px 2px rgba(0,0,0,.04);
            --shadow-md:0 4px 12px rgba(0,0,0,.08), 0 2px 4px rgba(0,0,0,.04);
            --shadow-lg:0 12px 32px rgba(0,0,0,.12), 0 4px 8px rgba(0,0,0,.06);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            line-height: 1.55;
            -webkit-font-smoothing: antialiased;
        }

        /* ── Animations ── */
        @keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
        @keyframes slideIn { from{transform:translateX(100%)} to{transform:translateX(0)} }
        @keyframes spin { to{transform:rotate(360deg)} }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.45} }
        @keyframes shimmer { 0%{background-position:-200% 0} 100%{background-position:200% 0} }

        .fade-up   { animation: fadeUp .3s ease forwards; }
        .slide-in  { animation: slideIn .28s cubic-bezier(.4,0,.2,1) forwards; }

        /* ── Typography ── */
        .mono { font-family: 'DM Mono', monospace; }

        /* ── Layout ── */
        #root { min-height: 100vh; }
        .app-wrap { max-width: 1440px; margin: 0 auto; padding: 24px; }

        /* ── Header ── */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        .header-title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -.3px;
            color: var(--text);
        }
        .header-right { display:flex; align-items:center; gap:12px; }
        .welcome-text { font-size:13px; color:var(--muted); }

        /* ── Buttons ── */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 600;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            border: none;
            transition: all .15s ease;
            white-space: nowrap;
        }
        .btn:disabled { opacity:.45; cursor:not-allowed; }
        .btn-primary { background:var(--indigo); color:#fff; }
        .btn-primary:not(:disabled):hover { background:var(--indigo-h); }
        .btn-green   { background:var(--green);  color:#fff; }
        .btn-green:not(:disabled):hover { opacity:.88; }
        .btn-red     { background:var(--red);    color:#fff; }
        .btn-red:not(:disabled):hover { opacity:.88; }
        .btn-amber   { background:var(--amber);  color:#fff; }
        .btn-amber:not(:disabled):hover { opacity:.88; }
        .btn-ghost   { background:transparent; color:var(--muted); border:1px solid var(--border-2); }
        .btn-ghost:not(:disabled):hover { background:var(--bg); color:var(--text); }
        .btn-sm { padding:6px 12px; font-size:12px; }
        .btn-round { border-radius: 20px; padding: 9px 20px; }

        /* ── Cards / Panels ── */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        .card-body { padding: 24px; }

        /* ── Form controls ── */
        .field { display:flex; flex-direction:column; gap:5px; }
        .field label { font-size:12px; font-weight:600; color:var(--muted); letter-spacing:.4px; text-transform:uppercase; }
        .field input, .field select, .field textarea {
            background: var(--bg);
            border: 1px solid var(--border-2);
            border-radius: var(--radius-sm);
            padding: 9px 12px;
            font-size: 14px;
            font-family: 'Outfit', sans-serif;
            color: var(--text);
            transition: border-color .15s, box-shadow .15s;
            outline: none;
        }
        .field input:focus, .field select:focus, .field textarea:focus {
            border-color: var(--indigo);
            box-shadow: 0 0 0 3px rgba(61,53,200,.1);
        }
        .field input[readonly] { opacity:.6; cursor:default; }
        .field select { cursor:pointer; }
        .field textarea { resize:vertical; min-height:72px; }

        /* ── Selects (header controls) ── */
        .ctrl-select {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 8px 12px;
            font-size: 13px;
            font-family: 'Outfit', sans-serif;
            color: var(--text);
            cursor: pointer;
            outline: none;
            min-width: 180px;
            transition: border-color .15s;
        }
        .ctrl-select:focus { border-color:var(--indigo); }
        .ctrl-label { font-size:11px; font-weight:600; color:var(--muted); letter-spacing:.5px; text-transform:uppercase; margin-bottom:3px; }

        /* ── Table ── */
        .tbl-wrap { border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; }
        table { width:100%; border-collapse:collapse; background:var(--surface); }
        thead tr { background:var(--bg); }
        thead th {
            padding: 11px 16px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            color: var(--muted);
            letter-spacing: .6px;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border);
        }
        tbody tr { transition: background .12s; border-bottom: 1px solid var(--border); }
        tbody tr:last-child { border-bottom: none; }
        tbody tr.clickable:hover { background: #F9F8F6; cursor:pointer; }
        tbody tr.expanded { background: #F9F8F6; }
        tbody td { padding: 13px 16px; font-size:13px; color:var(--text); vertical-align:middle; }

        /* ── Badges ── */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 9px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: .2px;
        }
        .badge-green  { background:var(--green-l);  color:var(--green); }
        .badge-amber  { background:var(--amber-l);  color:var(--amber); }
        .badge-indigo { background:var(--indigo-l); color:var(--indigo); }
        .badge-dot { width:5px;height:5px;border-radius:50%;background:currentColor;display:inline-block; }

        /* ── Score pill ── */
        .score-pill {
            font-family: 'DM Mono', monospace;
            font-size: 15px;
            font-weight: 500;
            color: var(--text);
        }

        /* ── Expanded row detail ── */
        .detail-wrap {
            padding: 20px 24px;
            background: var(--bg);
            border-top: 1px solid var(--border);
        }
        .detail-sub-tbl { width:100%; border-collapse:collapse; }
        .detail-sub-tbl th { padding:8px 12px; font-size:11px; font-weight:700; color:var(--muted); letter-spacing:.5px; text-transform:uppercase; border-bottom:1px solid var(--border); }
        .detail-sub-tbl td { padding:8px 12px; font-size:13px; }
        .detail-sub-tbl tr:not(:last-child) td { border-bottom:1px solid var(--border); }

        /* ── Progress stats ── */
        .stats-row {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }
        .stat-card {
            flex: 1;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .stat-label { font-size:11px; font-weight:600; color:var(--muted); letter-spacing:.5px; text-transform:uppercase; }
        .stat-value { font-family:'DM Mono',monospace; font-size:28px; font-weight:500; color:var(--text); line-height:1; }
        .stat-sub { font-size:12px; color:var(--muted-2); }
        .stat-bar { height:3px; background:var(--border); border-radius:2px; margin-top:8px; overflow:hidden; }
        .stat-bar-fill { height:100%; border-radius:2px; transition:width .6s cubic-bezier(.4,0,.2,1); }

        /* ── Skeleton ── */
        .skel {
            background: linear-gradient(90deg, var(--border) 25%, var(--bg) 50%, var(--border) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.4s infinite;
            border-radius: 4px;
            height: 14px;
        }

        /* ── Modal overlay ── */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.45);
            backdrop-filter: blur(2px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            animation: fadeUp .2s ease;
        }
        .modal-box {
            background: var(--surface);
            border-radius: 14px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 780px;
            max-height: 92vh;
            overflow-y: auto;
            animation: fadeUp .25s ease;
        }
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            background: var(--surface);
            z-index: 10;
        }
        .modal-title { font-size:17px; font-weight:700; color:var(--text); }
        .modal-subtitle { font-size:12px; color:var(--muted); margin-top:2px; }
        .modal-body { padding: 24px; display:flex; flex-direction:column; gap:20px; }
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            bottom: 0;
            background: var(--surface);
        }
        .modal-close {
            width: 32px; height: 32px;
            border-radius: 6px;
            border: none;
            background: var(--bg);
            color: var(--muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: background .15s, color .15s;
        }
        .modal-close:hover { background:var(--red-l); color:var(--red); }

        /* ── Criterion card ── */
        .criterion-card {
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            overflow: hidden;
            transition: border-color .15s, box-shadow .15s;
        }
        .criterion-card.is-error   { border-color:var(--red);   box-shadow:0 0 0 2px rgba(217,53,53,.08); }
        .criterion-card.is-correct { border-color:var(--green);  box-shadow:0 0 0 2px rgba(22,160,122,.06); }
        .criterion-card.is-deficiency { border-color:var(--amber); box-shadow:0 0 0 2px rgba(201,122,16,.07); }

        .criterion-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            background: var(--bg);
            gap: 10px;
        }
        .criterion-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            flex: 1;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .criterion-weight {
            font-family:'DM Mono',monospace;
            font-size:11px;
            color:var(--muted-2);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1px 6px;
        }
        .criterion-critical {
            font-size:10px;
            font-weight:700;
            color:var(--red);
            background:var(--red-l);
            border-radius:4px;
            padding:1px 6px;
            letter-spacing:.3px;
            text-transform:uppercase;
        }

        /* ── Score buttons ── */
        .score-btns {
            display: flex;
            gap: 6px;
            padding: 10px 14px;
            flex-wrap: wrap;
            background: var(--surface);
        }
        .score-btn {
            flex: 1;
            min-width: 80px;
            padding: 7px 10px;
            border-radius: 6px;
            border: 1.5px solid var(--border);
            font-size: 12px;
            font-weight: 600;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            transition: all .13s ease;
            text-align: center;
            background: var(--surface);
            color: var(--muted);
        }
        .score-btn:hover { border-color:var(--border-2); color:var(--text); }
        .score-btn.active-correct    { background:var(--green-l);  border-color:var(--green); color:var(--green); }
        .score-btn.active-na         { background:#F0F0F0;          border-color:#999;          color:#555; }
        .score-btn.active-incorrect  { background:var(--red-l);    border-color:var(--red);   color:var(--red); }
        .score-btn.active-deficiency { background:var(--amber-l);  border-color:var(--amber); color:var(--amber); }
        .score-btn.active-error      { background:var(--red-l);    border-color:var(--red);   color:var(--red); }

        /* ── Comment area in criterion ── */
        .criterion-comment { padding: 0 14px 12px; }
        .criterion-comment textarea {
            width: 100%;
            border: 1px solid var(--border-2);
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 13px;
            font-family: 'Outfit', sans-serif;
            color: var(--text);
            background: var(--bg);
            resize: vertical;
            min-height: 60px;
            outline: none;
            transition: border-color .15s;
        }
        .criterion-comment textarea:focus { border-color:var(--indigo); box-shadow:0 0 0 3px rgba(61,53,200,.08); }
        .criterion-comment textarea.required-empty { border-color:var(--red); }

        /* ── Criterion info panel ── */
        .info-panel {
            position: fixed;
            top: 0; right: 0;
            width: 360px;
            height: 100vh;
            background: var(--surface);
            border-left: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            z-index: 200;
            display: flex;
            flex-direction: column;
            animation: slideIn .25s cubic-bezier(.4,0,.2,1);
        }
        .info-panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .info-panel-body { padding:16px 20px; overflow-y:auto; flex:1; }
        .info-panel-title { font-size:14px; font-weight:700; }

        /* ── Progress indicator ── */
        .progress-strip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            color: var(--muted);
        }
        .progress-strip-bar { flex:1; height:4px; background:var(--border); border-radius:2px; overflow:hidden; }
        .progress-strip-fill { height:100%; background:var(--indigo); border-radius:2px; transition:width .3s ease; }

        /* ── Date picker ── */
        .flatpickr-input { background: var(--bg) !important; border:1px solid var(--border-2) !important; border-radius:6px !important; padding:8px 12px !important; font-size:13px !important; font-family:'Outfit',sans-serif !important; color:var(--text) !important; width:100% !important; cursor:pointer !important; outline:none !important; }

        /* ── Range visual ── */
        .range-bar { height:4px; background:var(--border); border-radius:2px; overflow:hidden; margin-top:6px; }
        .range-fill { height:100%; background:var(--indigo); border-radius:2px; transition:width .5s ease; }
        .range-labels { display:flex;justify-content:space-between;font-size:11px;color:var(--muted-2);margin-top:4px;font-family:'DM Mono',monospace; }

        /* ── Audio player wrapper ── */
        .audio-sticky {
            position: sticky;
            top: 0;
            z-index: 5;
            background: var(--indigo-l);
            border: 1px solid rgba(61,53,200,.15);
            border-radius: var(--radius-sm);
            padding: 10px 14px;
        }
        .audio-sticky label { font-size:11px;font-weight:700;color:var(--indigo);letter-spacing:.4px;text-transform:uppercase;display:block;margin-bottom:6px; }
        .audio-sticky audio { width:100%;height:36px; }

        /* ── Duration warning ── */
        .dur-warn { background:var(--red-l);border:1px solid rgba(217,53,53,.2);border-radius:6px;padding:8px 12px;font-size:12px;color:var(--red);display:flex;align-items:center;gap:6px; }

        /* ── Versions modal ── */
        .version-card { border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;background:var(--bg); }
        .version-card + .version-card { margin-top:12px; }

        /* ── Empty state ── */
        .empty-state { text-align:center;padding:60px 20px; }
        .empty-state-icon { font-size:40px;margin-bottom:12px;opacity:.3; }
        .empty-state-title { font-size:16px;font-weight:600;color:var(--text);margin-bottom:6px; }
        .empty-state-text  { font-size:13px;color:var(--muted); }

        /* ── Tooltip ── */
        .tooltip-wrap { position:relative;display:inline-flex; }
        .tooltip-box {
            position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);
            background:#1A1814;color:#fff;font-size:12px;border-radius:6px;padding:6px 10px;
            white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .15s;z-index:300;
            min-width:180px;white-space:normal;text-align:left;
        }
        .tooltip-wrap:hover .tooltip-box { opacity:1; }

        /* ── Spinner ── */
        .spinner { width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;display:inline-block; }

        /* ── Sv request badge ── */
        .sv-pending { display:inline-flex;align-items:center;gap:5px;font-size:12px;color:var(--amber);font-weight:600; }
        .sv-approved { display:inline-flex;align-items:center;gap:5px;font-size:12px;color:var(--green);font-weight:600; }

        /* ── Scrollbar ── */
        ::-webkit-scrollbar { width:5px;height:5px; }
        ::-webkit-scrollbar-track { background:transparent; }
        ::-webkit-scrollbar-thumb { background:var(--border-2);border-radius:3px; }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;
    const API_BASE_URL = 'https://otp-2-fos4.onrender.com';
    const AUTH_REFRESH_URL = `${API_BASE_URL}/api/auth/refresh`;
    let refreshPromise = null;

    const readJsonSafe = async (response) => {
        try { return await response.json(); } catch(_) { return null; }
    };

    const authFetch = async (url, options = {}, retry = true) => {
        const requestOptions = { credentials:'include', ...options, headers:{...(options.headers||{})} };
        const response = await fetch(url, requestOptions);
        if (response.status !== 401 || !retry) return response;
        const body = await readJsonSafe(response.clone());
        if (!body || body.code !== 'TOKEN_EXPIRED') return response;
        if (!refreshPromise) {
            refreshPromise = fetch(AUTH_REFRESH_URL,{method:'POST',credentials:'include'}).finally(()=>{refreshPromise=null;});
        }
        const refreshResponse = await refreshPromise;
        if (!refreshResponse.ok) return response;
        return authFetch(url, options, false);
    };

    const audioUrlCache = {};
    const getAudioUrlWithAuth = async (evaluationId, userId) => {
        if (audioUrlCache[evaluationId]) return audioUrlCache[evaluationId];
        try {
            const response = await authFetch(`${API_BASE_URL}/api/audio/${evaluationId}`,{method:'GET',headers:{'X-User-Id':userId}});
            if (!response.ok) throw new Error(`Failed: ${response.status}`);
            const data = await response.json();
            if (data?.url) { audioUrlCache[evaluationId] = data.url; return data.url; }
            return null;
        } catch(error) { console.error('Audio fetch error:', error); return null; }
    };

    const safeAtob = (str) => decodeURIComponent(Array.prototype.map.call(atob(str),(c)=>'%'+('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));

    const escapeHtml = (s) => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');

    const parseToHtml = (text) => {
        if (!text) return '';
        const lines = text.split(/\r?\n/);
        let html = ''; const listStack = [];
        const closeLists=(toLevel=0)=>{ while(listStack.length>toLevel){const t=listStack.pop();html+=t==='ol'?'</ol>':'</ul>';} };
        const orderedMatch=(line)=>line.match(/^\s*(\d+(?:\.\d+)*)\.\s*(.*)$/);
        for(let i=0;i<lines.length;i++){
            const line=lines[i].replace(/\t/g,'    ');
            if(!line.trim()){closeLists(0);html+='<p>&nbsp;</p>';continue;}
            const om=orderedMatch(line);
            if(om){const level=om[1].split('.').length;const content=escapeHtml(om[2].trim());
                if(listStack.length<level){for(let j=listStack.length;j<level;j++){html+=`<ol class="list-ol">`;listStack.push('ol');}}
                else if(listStack.length>level)closeLists(level);
                html+=`<li>${content}</li>`;continue;}
            const ulm=line.match(/^\s*[-•\*]\s+(.*)$/);
            if(ulm){if(listStack.length===0||listStack[listStack.length-1]!=='ul'){html+='<ul class="list-ul">';listStack.push('ul');}
                html+=`<li>${escapeHtml(ulm[1].trim())}</li>`;continue;}
            closeLists(0);html+=`<p>${escapeHtml(line)}</p>`;
        }
        closeLists(0); return html;
    };

    const FormattedDescription = ({ text }) => {
        const html = parseToHtml(String(text||''));
        return React.createElement('div',{
            style:{fontSize:'13px',color:'var(--muted)',lineHeight:'1.6'},
            dangerouslySetInnerHTML:{__html:html}
        });
    };

    const monthsRu = ['янв.','февр.','мар.','апр.','май','июн.','июл.','авг.','сент.','окт.','ноя.','дек.'];

    /* ─────── LOGIN MODAL ─────── */
    const LoginModal = ({ isOpen, onClose, onLogin }) => {
        const [login,setLogin]=useState('');
        const [password,setPassword]=useState('');
        const [error,setError]=useState('');
        const [loading,setLoading]=useState(false);

        const handleSubmit = async (e) => {
            e.preventDefault(); setLoading(true);
            try {
                const response = await authFetch(`${API_BASE_URL}/api/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({login,password})});
                const data = await response.json();
                if(data.status==='success'){
                    const loggedIn=onLogin(data.user||data);
                    if(loggedIn!==false){setError('');onClose();}else setError('Invalid login response');
                }else setError(data.error||'Invalid credentials');
            } catch(err){setError('Failed to login: '+err.message);}
            finally{setLoading(false);}
        };

        if (!isOpen) return null;
        return (
            <div className="modal-overlay" onClick={onClose}>
                <div className="modal-box" style={{maxWidth:400}} onClick={e=>e.stopPropagation()}>
                    <div className="modal-header">
                        <div>
                            <div className="modal-title">Вход в систему</div>
                            <div className="modal-subtitle">Оценки операторов</div>
                        </div>
                    </div>
                    <div className="modal-body">
                        {error && <div style={{background:'var(--red-l)',color:'var(--red)',border:'1px solid rgba(217,53,53,.2)',borderRadius:'6px',padding:'10px 12px',fontSize:'13px'}}>{error}</div>}
                        <div className="field"><label>Логин</label><input type="text" value={login} onChange={e=>setLogin(e.target.value)} placeholder="Введите логин" onKeyDown={e=>e.key==='Enter'&&handleSubmit(e)}/></div>
                        <div className="field"><label>Пароль</label><input type="password" value={password} onChange={e=>setPassword(e.target.value)} placeholder="Введите пароль" onKeyDown={e=>e.key==='Enter'&&handleSubmit(e)}/></div>
                    </div>
                    <div className="modal-footer">
                        <button className="btn btn-ghost" onClick={onClose}>Отмена</button>
                        <button className="btn btn-primary" onClick={handleSubmit} disabled={loading}>
                            {loading?<><span className="spinner" style={{borderTopColor:'#fff'}}></span> Вход...</>:'Войти'}
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    /* ─────── SCORE BUTTON GROUP ─────── */
    const ScoreButtonGroup = ({ criterion, value, onChange }) => {
        const options = [];
        options.push({key:'Correct',    label:'Корректно',  cls:'active-correct'});
        options.push({key:'N/A',        label:'N/A',        cls:'active-na'});
        if (criterion.isCritical) {
            options.push({key:'Error', label:'Ошибка',     cls:'active-error'});
        } else {
            options.push({key:'Incorrect', label:'Ошибка', cls:'active-incorrect'});
            if (criterion.deficiency) {
                options.push({key:'Deficiency', label:'Недочёт', cls:'active-deficiency'});
            }
        }
        return (
            <div className="score-btns">
                {options.map(opt=>(
                    <button key={opt.key}
                        className={`score-btn ${value===opt.key?opt.cls:''}`}
                        onClick={()=>onChange(opt.key)}
                        type="button"
                    >{opt.label}</button>
                ))}
            </div>
        );
    };

    /* ─────── CRITERION CARD ─────── */
    const CriterionCard = ({ criterion, index, score, comment, commentVisible, onScoreChange, onCommentChange, onToggleComment, onInfo }) => {
        const isNeg = score==='Error'||score==='Incorrect'||score==='Deficiency';
        const cardCls = score==='Correct'||score==='N/A'?'is-correct':score==='Deficiency'?'is-deficiency':'is-error';

        return (
            <div className={`criterion-card ${cardCls} fade-up`}>
                <div className="criterion-head">
                    <div className="criterion-name">
                        {criterion.isCritical
                            ? <span className="criterion-critical">Крит.</span>
                            : <span className="criterion-weight">{criterion.weight}</span>}
                        {criterion.name}
                    </div>
                    <button
                        onClick={()=>onInfo(index)}
                        style={{background:'none',border:'none',cursor:'pointer',color:'var(--muted-2)',fontSize:'14px',padding:'2px 4px',borderRadius:'4px',transition:'color .15s'}}
                        title="Описание критерия"
                        onMouseEnter={e=>e.currentTarget.style.color='var(--indigo)'}
                        onMouseLeave={e=>e.currentTarget.style.color='var(--muted-2)'}
                    ><i className="fa-regular fa-circle-question"></i></button>
                    <button
                        onClick={()=>onToggleComment(index)}
                        style={{background:'none',border:'none',cursor:'pointer',color:commentVisible?'var(--indigo)':'var(--muted-2)',fontSize:'14px',padding:'2px 4px',borderRadius:'4px',transition:'color .15s'}}
                        title="Комментарий"
                    ><i className="fa-regular fa-comment-dots"></i></button>
                </div>
                <ScoreButtonGroup criterion={criterion} value={score} onChange={v=>onScoreChange(index,v)} />
                {(isNeg||commentVisible) && (
                    <div className="criterion-comment">
                        <textarea
                            value={comment||''}
                            onChange={e=>onCommentChange(index,e.target.value)}
                            placeholder={`Комментарий${isNeg?' (обязательно)':' (необязательно)'}`}
                            className={isNeg&&!comment?.trim()?'required-empty':''}
                            rows={2}
                        />
                    </div>
                )}
            </div>
        );
    };

    /* ─────── EVALUATION MODAL ─────── */
    const EvaluationModal = ({ isOpen, onClose, onSubmit, directions, operator, selectedMonth, userId, userName, existingEvaluation }) => {
        const [callFile,setCallFile]=useState(null);
        const [audioUrl,setAudioUrl]=useState(null);
        const [audioError,setAudioError]=useState(null);
        const [scores,setScores]=useState([]);
        const [criterionComments,setCriterionComments]=useState([]);
        const [commentVisible,setCommentVisible]=useState([]);
        const [phoneNumber,setPhoneNumber]=useState('');
        const [phoneError,setPhoneError]=useState('');
        const [shownCriterionIndex,setShownCriterionIndex]=useState(null);
        const [assignedMonth,setAssignedMonth]=useState(selectedMonth);
        const [isDraft,setIsDraft]=useState(false);
        const [isSubmitting,setIsSubmitting]=useState(false);
        const [appealDate,setAppealDate]=useState('');
        const [expectedDuration,setExpectedDuration]=useState(null);
        const [actualDuration,setActualDuration]=useState(null);
        const [durationMismatch,setDurationMismatch]=useState(false);
        const [selectedDirectionId,setSelectedDirectionId]=useState(null);

        const MIN_TOLERANCE_SEC=3; const PERCENT_TOLERANCE=0.15;
        const formatSeconds=(secs)=>{ if(secs===null||secs===undefined||isNaN(secs))return'—'; const total=Math.round(secs);const h=Math.floor(total/3600);const m=Math.floor((total%3600)/60);const s=total%60; if(h>0)return`${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; return`${m}:${String(s).padStart(2,'0')}`; };

        const currentDirection = directions&&directions.length>0?(directions.find(d=>d.id===selectedDirectionId)||directions[0]):null;
        const isLocked = !!(existingEvaluation?.isReevaluation||existingEvaluation?.is_imported);

        useEffect(()=>{
            if(isOpen&&directions&&directions.length>0){
                const initialDirId=existingEvaluation?(existingEvaluation.directionId??existingEvaluation._rawEvaluation?.direction_id??directions.find(d=>d.name===existingEvaluation.selectedDirection)?.id??operator?.direction_id??directions[0]?.id):(operator?.direction_id??directions[0]?.id);
                setSelectedDirectionId(initialDirId);
                const initialDir=directions.find(d=>d.id===initialDirId)||directions[0];
                if(existingEvaluation){
                    if(existingEvaluation.is_imported){
                        const ed=existingEvaluation.duration||(existingEvaluation._rawEvaluation&&existingEvaluation._rawEvaluation.duration)||null;
                        setExpectedDuration(ed?parseFloat(ed):null);
                        setActualDuration(null);setDurationMismatch(false);
                        setPhoneNumber(existingEvaluation.phoneNumber||'');
                        const date=new Date(existingEvaluation.appeal_date);
                        const hfu=initialDir?.hasFileUpload;
                        let formatted;
                        if(hfu){formatted=`${date.getDate().toString().padStart(2,'0')}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getFullYear()} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}:${date.getSeconds().toString().padStart(2,'0')}`;}
                        else{formatted=`${date.getDate()} ${monthsRu[date.getMonth()]} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;}
                        setAppealDate(formatted);
                        setScores(initialDir?.criteria?.map(()=>'Correct')||[]);
                        setCriterionComments(initialDir?.criteria?.map(()=>'')||[]);
                        setCommentVisible(initialDir?.criteria?.map(()=>false)||[]);
                        setAssignedMonth(selectedMonth);setIsDraft(false);setAudioUrl(null);setPhoneError('');
                    }else{
                        setScores(existingEvaluation.scores||[]);
                        setCriterionComments(existingEvaluation.criterionComments||[]);
                        setActualDuration(null);setDurationMismatch(false);
                        const vis=(existingEvaluation.criterionComments||[]).map(c=>!!(c&&c.trim()));
                        setCommentVisible(vis.length?vis:(initialDir?.criteria?.map(()=>false)||[]));
                        setPhoneNumber(existingEvaluation.phoneNumber||'');
                        setAssignedMonth(existingEvaluation.assignedMonth||selectedMonth);
                        setIsDraft(existingEvaluation.isDraft||false);
                        setAudioUrl(existingEvaluation.audioUrl||null);setPhoneError('');
                        if(existingEvaluation.appeal_date){
                            const date=new Date(existingEvaluation.appeal_date);
                            const hfu=initialDir?.hasFileUpload;
                            let formatted;
                            if(hfu){formatted=`${date.getDate().toString().padStart(2,'0')}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getFullYear()} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}:${date.getSeconds().toString().padStart(2,'0')}`;}
                            else{formatted=`${date.getDate()} ${monthsRu[date.getMonth()]} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;}
                            setAppealDate(formatted);
                        }else setAppealDate('');
                    }
                }else{
                    setExpectedDuration(null);setActualDuration(null);setDurationMismatch(false);
                    setScores(initialDir?.criteria?.map(()=>'Correct')||[]);
                    setCriterionComments(initialDir?.criteria?.map(()=>'')||[]);
                    setCommentVisible(initialDir?.criteria?.map(()=>false)||[]);
                    setCallFile(null);setAudioUrl(null);setPhoneNumber('');
                    setAssignedMonth(selectedMonth);setIsDraft(false);setAppealDate('');setPhoneError('');
                }
            }
        },[isOpen,existingEvaluation,directions,selectedMonth,operator?.direction_id]);

        useEffect(()=>{
            const loadAudio=async()=>{
                if(existingEvaluation?.id&&currentDirection?.hasFileUpload&&userId&&!existingEvaluation?.is_imported){
                    setAudioError(null);
                    const url=await getAudioUrlWithAuth(existingEvaluation.id,userId);
                    if(url)setAudioUrl(url);else setAudioError('Не удалось загрузить аудио');
                }
            };
            loadAudio();
        },[existingEvaluation,userId,currentDirection?.hasFileUpload]);

        const handleFileChange=(e)=>{
            const file=e.target.files[0];setCallFile(file);
            const newAudioUrl=file?URL.createObjectURL(file):null;
            setAudioUrl(newAudioUrl);setAudioError(null);setActualDuration(null);setDurationMismatch(false);
            if(file&&newAudioUrl){
                try{
                    const audio=new Audio(newAudioUrl);
                    const onLoaded=()=>{ const dur=audio.duration;setActualDuration(dur);
                        if(expectedDuration&&!Number.isNaN(parseFloat(expectedDuration))){
                            const allowed=Math.max(MIN_TOLERANCE_SEC,expectedDuration*PERCENT_TOLERANCE);
                            if(Math.abs(dur-expectedDuration)>allowed){setDurationMismatch(true);setAudioError(`Длительность файла (${formatSeconds(dur)}) отличается от ожидаемой (${formatSeconds(expectedDuration)})`);}
                            else setDurationMismatch(false);
                        }else setDurationMismatch(false);
                        audio.removeEventListener('loadedmetadata',onLoaded);
                    };
                    const onError=()=>{setAudioError('Не удалось прочитать аудио-файл');audio.removeEventListener('error',onError);};
                    audio.addEventListener('loadedmetadata',onLoaded);audio.addEventListener('error',onError);audio.load();
                }catch(err){setAudioError('Ошибка при проверке длительности аудио');}
            }
        };

        const handleScoreChange=(index,value)=>{ const ns=[...scores];ns[index]=value;setScores(ns); };
        const handleCommentChange=(index,value)=>{ const nc=[...criterionComments];nc[index]=value;setCriterionComments(nc); };
        const handleToggleComment=(index)=>{ const nv=[...commentVisible];nv[index]=!nv[index];setCommentVisible(nv); };
        const handlePhoneChange=(e)=>{ let value=e.target.value.replace(/[^0-9+]/g,'');setPhoneNumber(value);setPhoneError(value.length<5&&value.length>0?'Слишком короткий номер':''); };

        const handleDirectionChange=(e)=>{
            const newId=Number(e.target.value)||e.target.value;setSelectedDirectionId(newId);
            const newDir=directions.find(d=>d.id===newId)||directions[0];
            if(newDir?.criteria){setScores(newDir.criteria.map(()=>'Correct'));setCriterionComments(newDir.criteria.map(()=>''));setCommentVisible(newDir.criteria.map(()=>false));}
        };

        const formatAppealDate=(input)=>{
            const hfu=currentDirection?.hasFileUpload;
            if(hfu){
                let digits=input.replace(/\D/g,'');
                if(digits.length>14)digits=digits.slice(0,14);
                let f='';
                if(digits.length>0)f+=digits.slice(0,2);if(digits.length>2)f+='-'+digits.slice(2,4);if(digits.length>4)f+='-'+digits.slice(4,8);
                if(digits.length>8)f+=' '+digits.slice(8,10);if(digits.length>10)f+=':'+digits.slice(10,12);if(digits.length>12)f+=':'+digits.slice(12,14);
                return f;
            }else{
                let text=input.trim();
                const hasMonth=monthsRu.some(m=>text.toLowerCase().includes(m.toLowerCase()));
                if(hasMonth){
                    const pattern=/^(\d{1,2})\s+([а-яё]+\.?)\s+(\d{1,2}):(\d{2})$/i;const match=text.match(pattern);
                    if(match){const day=match[1];const month=match[2];const hh=match[3].padStart(2,'0');const mm=match[4];return`${day} ${month} ${hh}:${mm}`;}
                    const pp=/(\d{1,2})\s+([а-яё]+\.?)\s*(\d{0,2}):?(\d{0,2})/i;const pm=text.match(pp);
                    if(pm){const day=pm[1].padStart(2,'0');const month=pm[2];const hh=pm[3]?pm[3].padStart(2,'0'):'';const mm=pm[4]?pm[4].padStart(2,'0'):'';
                        if(hh&&mm)return`${day} ${month} ${hh}:${mm}`;else if(hh)return`${day} ${month} ${hh}`;else return`${day} ${month}`;}
                    return text;
                }
                let digits=input.replace(/\D/g,'');
                if(digits.length>0){
                    if(digits.length<=2)return digits;
                    else if(digits.length<=4){const day=digits.slice(0,2);const mn=parseInt(digits.slice(2,4));return(mn>=1&&mn<=12)?day+' '+monthsRu[mn-1]:day;}
                    else if(digits.length<=6){const day=digits.slice(0,2);const mn=parseInt(digits.slice(2,4));const hh=digits.slice(4,6);return(mn>=1&&mn<=12)?day+' '+monthsRu[mn-1]+' '+hh:day+' '+hh;}
                    else{const day=digits.slice(0,2);const mn=parseInt(digits.slice(2,4));const hh=digits.slice(4,6);const mm=digits.slice(6,8);return(mn>=1&&mn<=12)?day+' '+monthsRu[mn-1]+' '+hh+':'+mm:day+' '+hh+':'+mm;}
                }
                return text;
            }
        };

        const getAppealDate=()=>{
            if(!appealDate)return null;
            const hfu=currentDirection?.hasFileUpload;const isReEval=existingEvaluation?.id!=null;
            if(hfu){
                let digits=appealDate.replace(/\D/g,'');
                if(isReEval){if(digits.length<12)return null;const seconds=digits.length>=14?digits.slice(12,14):'00';return`${digits.slice(4,8)}-${digits.slice(2,4)}-${digits.slice(0,2)}T${digits.slice(8,10)}:${digits.slice(10,12)}:${seconds}`;}
                if(digits.length!==14)return null;return`${digits.slice(4,8)}-${digits.slice(2,4)}-${digits.slice(0,2)}T${digits.slice(8,10)}:${digits.slice(10,12)}:${digits.slice(12,14)}`;
            }else{
                const text=appealDate.trim();const pattern=/^(\d{1,2})\s+([а-яё]+\.?)\s+(\d{1,2}):(\d{2})$/i;const match=text.match(pattern);
                if(!match)return null;
                const day=match[1].padStart(2,'0');const monthStr=match[2].toLowerCase().replace(/\./,'');const hh=match[3].padStart(2,'0');const mm=match[4];
                const monthIndex=monthsRu.findIndex(m=>m.replace(/\./,'').toLowerCase()===monthStr);if(monthIndex===-1)return null;
                return`${new Date().getFullYear()}-${String(monthIndex+1).padStart(2,'0')}-${day}T${hh}:${mm}:00`;
            }
        };

        const criteria = currentDirection?.criteria || [];
        const completedCount = scores.filter((s,i)=>{
            const neg=s==='Error'||s==='Incorrect'||s==='Deficiency';
            if(neg&&!criterionComments[i]?.trim())return false;
            return true;
        }).length;
        const totalCriteria = criteria.length;
        const completionPct = totalCriteria>0?Math.round((completedCount/totalCriteria)*100):0;

        const totalScore = useMemo(()=>{
            const hasCritErr=criteria.some((c,i)=>c.isCritical&&scores[i]==='Error');
            if(hasCritErr)return 0;
            return criteria.reduce((sum,c,i)=>{
                if(c.isCritical)return sum;
                if(scores[i]==='Correct'||scores[i]==='N/A')return sum+c.weight;
                if(scores[i]==='Deficiency'&&c.deficiency)return sum+c.deficiency.weight;
                return sum;
            },0);
        },[scores,criteria]);

        const isSubmitDisabled = !currentDirection||directions.length===0||criteria.length===0||
            (currentDirection?.hasFileUpload&&!callFile&&!audioUrl)||
            scores.some((s,i)=>(s==='Error'||s==='Incorrect')&&!criterionComments[i]?.trim())||
            durationMismatch;

        const handleSubmit=async(saveAsDraft=false)=>{
            setIsSubmitting(true);
            if(isSubmitDisabled&&!saveAsDraft)return;
            const hasCritErr=criteria.some((c,i)=>c.isCritical&&scores[i]==='Error');
            const finalScore=hasCritErr?0:totalScore;
            const combinedComment=criterionComments.map((cm,i)=>cm?`${criteria[i].name}: ${cm}`:''). filter(c=>c).join('; ');
            const formData=new FormData();
            formData.append('evaluator',userName);formData.append('operator',operator.name);
            formData.append('phone_number',phoneNumber);formData.append('score',finalScore);
            formData.append('comment',combinedComment);formData.append('month',assignedMonth);
            formData.append('is_draft',saveAsDraft);formData.append('scores',JSON.stringify(scores));
            formData.append('criterion_comments',JSON.stringify(criterionComments));
            formData.append('direction',currentDirection?.id??operator?.direction_id);
            const appeal_date=getAppealDate();if(appeal_date)formData.append('appeal_date',appeal_date);
            if(existingEvaluation?.isReevaluation){formData.append('previous_version_id',existingEvaluation.id);formData.append('is_correction',true);}
            if(callFile)formData.append('audio_file',callFile);
            try{
                const response=await authFetch(`${API_BASE_URL}/api/call_evaluation`,{method:'POST',headers:{'X-User-Id':userId},body:formData});
                const result=await response.json();
                if(result.status==='success'){
                    onSubmit({id:result.evaluation_id,evaluator:userName,operator:operator.name,phoneNumber,totalScore:finalScore.toFixed(2),comment:combinedComment,selectedDirection:currentDirection?.name,directionId:currentDirection?.id??null,is_imported:false,directions:[{name:currentDirection?.name,hasFileUpload:currentDirection?.hasFileUpload,criteria}],scores,criterionComments,audioUrl:currentDirection?.hasFileUpload?audioUrl:null,isDraft:saveAsDraft,assignedMonth,isCorrection:existingEvaluation?.isReevaluation||false,appeal_date});
                    onClose();
                }else alert('Ошибка: '+result.error);
            }catch(err){alert('Ошибка: '+err.message);}
            finally{setIsSubmitting(false);}
        };

        const handleDeleteDraft=async()=>{
            if(!existingEvaluation?.isDraft)return;
            try{
                const response=await authFetch(`${API_BASE_URL}/api/call_evaluation/${existingEvaluation.id}`,{method:'DELETE',headers:{'X-User-Id':userId}});
                const result=await response.json();
                if(result.status==='success'){onSubmit(null);onClose();}else alert('Ошибка: '+result.error);
            }catch(err){alert('Ошибка: '+err.message);}
        };

        if (!isOpen) return null;

        const modalTitle = existingEvaluation?.isReevaluation?'Переоценка':existingEvaluation?.is_imported?'Оценить звонок':existingEvaluation?.isDraft?'Черновик':'Новая оценка';

        return (
            <div className="modal-overlay" onClick={onClose}>
                <div className="modal-box" style={{maxWidth:800}} onClick={e=>e.stopPropagation()}>
                    {/* Header */}
                    <div className="modal-header">
                        <div>
                            <div className="modal-title">{modalTitle}</div>
                            <div className="modal-subtitle">Оператор: {operator?.name}</div>
                        </div>
                        <button className="modal-close" onClick={onClose}><i className="fa-solid fa-xmark"></i></button>
                    </div>

                    {/* Direction selector */}
                    {directions&&directions.length>1&&(
                        <div style={{padding:'12px 24px',borderBottom:'1px solid var(--border)',background:'var(--bg)'}}>
                            <div className="ctrl-label">Направление</div>
                            <select className="ctrl-select" value={selectedDirectionId??''} onChange={handleDirectionChange} style={{width:'100%',maxWidth:360}}>
                                {directions.map(d=><option key={d.id} value={d.id}>{d.name}</option>)}
                            </select>
                        </div>
                    )}
                    {directions&&directions.length===1&&(
                        <div style={{padding:'8px 24px',borderBottom:'1px solid var(--border)',background:'var(--bg)',fontSize:'12px',color:'var(--muted)'}}>
                            Направление: <strong style={{color:'var(--text)'}}>{currentDirection?.name}</strong>
                        </div>
                    )}

                    <div className="modal-body">
                        {/* File upload */}
                        {currentDirection?.hasFileUpload&&(
                            <div style={{display:'flex',flexDirection:'column',gap:10}}>
                                {!existingEvaluation?.isReevaluation&&(
                                    <div className="field">
                                        <label>Аудио звонка <span style={{color:'var(--red)'}}>*</span></label>
                                        <input type="file" accept="audio/*" onChange={handleFileChange} style={{padding:'7px 10px',fontSize:'13px'}}/>
                                    </div>
                                )}
                                {audioUrl&&(
                                    <div className="audio-sticky">
                                        <label>Прослушать звонок</label>
                                        <audio controls style={{width:'100%',height:'36px'}}><source src={audioUrl} type="audio/mpeg"/>Ваш браузер не поддерживает audio.</audio>
                                    </div>
                                )}
                                {(expectedDuration||actualDuration)&&(
                                    <div style={{fontSize:'12px',color:'var(--muted)'}}>
                                        Ожидаемая: <strong>{expectedDuration?formatSeconds(expectedDuration):'—'}</strong>{' · '}Фактическая: <strong>{actualDuration?formatSeconds(actualDuration):'—'}</strong>
                                    </div>
                                )}
                                {durationMismatch&&<div className="dur-warn"><i className="fa-solid fa-triangle-exclamation"></i> Длительность не совпадает</div>}
                                {audioError&&!durationMismatch&&<div style={{fontSize:'12px',color:'var(--red)'}}>{audioError}</div>}
                            </div>
                        )}

                        {/* Phone + Date */}
                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16}}>
                            <div className="field">
                                <label>Номер телефона</label>
                                <input type="text" value={phoneNumber} onChange={handlePhoneChange} placeholder="+7 (999) 000-00-00" readOnly={isLocked}/>
                                {phoneError&&<span style={{fontSize:'11px',color:'var(--red)'}}>{phoneError}</span>}
                            </div>
                            <div className="field">
                                <label>Дата обращения</label>
                                <input type="text" value={appealDate} onChange={e=>setAppealDate(formatAppealDate(e.target.value))} placeholder={currentDirection?.hasFileUpload?'DD-MM-YYYY HH:MM:SS':'DD месяц HH:MM'} readOnly={isLocked}/>
                            </div>
                        </div>

                        {/* Criteria */}
                        <div>
                            {/* Progress */}
                            {criteria.length>0&&(
                                <div className="progress-strip" style={{borderRadius:'6px 6px 0 0',border:'1px solid var(--border)',borderBottom:'none'}}>
                                    <span style={{fontWeight:600,fontSize:'12px',color:'var(--text)'}}>Критерии</span>
                                    <div className="progress-strip-bar">
                                        <div className="progress-strip-fill" style={{width:`${completionPct}%`}}></div>
                                    </div>
                                    <span style={{fontFamily:'DM Mono',fontSize:'11px',minWidth:40,textAlign:'right'}}>{completedCount}/{totalCriteria}</span>
                                </div>
                            )}
                            {!currentDirection||!criteria.length?(
                                <div style={{padding:'16px',background:'var(--red-l)',borderRadius:'6px',color:'var(--red)',fontSize:'13px'}}>У направления нет критериев.</div>
                            ):(
                                <div style={{display:'flex',flexDirection:'column',gap:8,maxHeight:'400px',overflowY:'auto',padding:'2px',border:'1px solid var(--border)',borderRadius:'0 0 6px 6px',background:'var(--bg)'}}>
                                    {criteria.map((criterion,index)=>(
                                        <CriterionCard key={index}
                                            criterion={criterion} index={index}
                                            score={scores[index]||'Correct'}
                                            comment={criterionComments[index]||''}
                                            commentVisible={commentVisible[index]||false}
                                            onScoreChange={handleScoreChange}
                                            onCommentChange={handleCommentChange}
                                            onToggleComment={handleToggleComment}
                                            onInfo={setShownCriterionIndex}
                                        />
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Footer */}
                    <div className="modal-footer">
                        <div style={{display:'flex',alignItems:'center',gap:12}}>
                            {existingEvaluation?.isDraft&&(
                                <button className="btn btn-red btn-sm" onClick={handleDeleteDraft}>
                                    <i className="fa-regular fa-trash-can"></i> Удалить черновик
                                </button>
                            )}
                            <div style={{fontFamily:'DM Mono',fontSize:'20px',fontWeight:500,color:totalScore>=80?'var(--green)':totalScore>=60?'var(--amber)':'var(--red)'}}>
                                {totalScore}<span style={{fontSize:'13px',color:'var(--muted)',fontWeight:400,fontFamily:'Outfit'}}>/100</span>
                            </div>
                        </div>
                        <div style={{display:'flex',gap:8}}>
                            <button className="btn btn-ghost" onClick={onClose}>Отмена</button>
                            <button className="btn btn-primary" onClick={()=>handleSubmit(false)} disabled={isSubmitDisabled||isSubmitting}>
                                {isSubmitting?<><span className="spinner"></span> Сохраняю...</>:<><i className="fa-solid fa-check"></i> Отправить</>}
                            </button>
                        </div>
                    </div>

                    {/* Info panel */}
                    {shownCriterionIndex!==null&&(
                        <div className="info-panel">
                            <div className="info-panel-header">
                                <div className="info-panel-title">{criteria[shownCriterionIndex]?.name}</div>
                                <button className="modal-close" onClick={()=>setShownCriterionIndex(null)}><i className="fa-solid fa-xmark"></i></button>
                            </div>
                            <div className="info-panel-body">
                                <FormattedDescription text={criteria[shownCriterionIndex]?.value||'Описание отсутствует'}/>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        );
    };

    /* ─────── DATE RANGE PICKER ─────── */
    const DateRangePicker = ({ minDate, maxDate, setFromDate, setToDate }) => {
        const [selectedDates,setSelectedDates]=useState([]);
        const inputRef=useRef(null);
        useEffect(()=>{
            if(inputRef.current){
                flatpickr(inputRef.current,{mode:'range',dateFormat:'Y-m-d',minDate,maxDate,onChange:(dates)=>{
                    setSelectedDates(dates);
                    if(dates.length===2){
                        const start=new Date(dates[0]);const end=new Date(dates[1]);
                        end.setDate(end.getDate()+1);end.setMilliseconds(end.getMilliseconds()-1);
                        setFromDate(start.toISOString());setToDate(end.toISOString());
                    }else{setFromDate(null);setToDate(null);}
                }});
            }
        },[minDate,maxDate]);

        const isValidRange=selectedDates.length===2;
        let rangePercentage=0;let startDate='';let endDate='';let diffDays=0;
        if(isValidRange){
            const diffTime=selectedDates[1]-selectedDates[0];
            diffDays=Math.floor(diffTime/(1000*60*60*24))+1;
            const maxDiff=Math.floor((new Date(maxDate)-new Date(minDate))/(1000*60*60*24))+1;
            rangePercentage=Math.min((diffDays/maxDiff)*100,100);
            startDate=selectedDates[0].toISOString().split('T')[0];endDate=selectedDates[1].toISOString().split('T')[0];
        }
        return (
            <div style={{display:'flex',flexDirection:'column',gap:4}}>
                <div className="ctrl-label">Период</div>
                <input ref={inputRef} type="text" className="ctrl-select" placeholder="Выбрать период" readOnly style={{cursor:'pointer'}}/>
                {isValidRange&&<>
                    <div className="range-bar"><div className="range-fill" style={{width:`${rangePercentage}%`}}></div></div>
                    <div className="range-labels"><span>{startDate}</span><span>{diffDays} дней</span><span>{endDate}</span></div>
                </>}
            </div>
        );
    };

    /* ─────── SV REQUEST BUTTON ─────── */
    function SvRequestButton({call,userId,userRole,fetchEvaluations}){
        const [showModal,setShowModal]=useState(false);const [comment,setComment]=useState('');const [loading,setLoading]=useState(false);
        const isSv=String(userRole)==='sv';
        async function submitRequest(e){
            if(e&&e.stopPropagation)e.stopPropagation();setLoading(true);
            try{
                const res=await authFetch(`${API_BASE_URL}/api/call_evaluation/sv_request`,{method:'POST',headers:{'Content-Type':'application/json','X-User-Id':userId},body:JSON.stringify({call_id:call.id,comment})});
                const data=await res.json();if(!res.ok)throw new Error(data.error||JSON.stringify(data));
                if(typeof fetchEvaluations==='function')await fetchEvaluations();
                setShowModal(false);setComment('');alert('Заявка отправлена администратору');
            }catch(err){alert('Ошибка: '+(err.message||'unknown'));}
            finally{setLoading(false);}
        }
        if(!isSv)return null;
        if(!call.sv_request)return(<>
            <button onClick={e=>{e.stopPropagation();setShowModal(true);}} className="btn btn-amber btn-sm">Запрос</button>
            {showModal&&(<div className="modal-overlay" style={{zIndex:300}} onClick={e=>{e.stopPropagation();setShowModal(false);}}>
                <div className="modal-box" style={{maxWidth:400}} onClick={e=>e.stopPropagation()}>
                    <div className="modal-header"><div className="modal-title">Запрос на переоценку</div><button className="modal-close" onClick={()=>setShowModal(false)}><i className="fa-solid fa-xmark"></i></button></div>
                    <div className="modal-body"><div style={{fontSize:'12px',color:'var(--muted)',marginBottom:8}}>Call ID: {call.id}</div><div className="field"><label>Комментарий</label><textarea value={comment} onChange={e=>setComment(e.target.value)} placeholder="Необязательно" rows={3}/></div></div>
                    <div className="modal-footer"><button className="btn btn-ghost btn-sm" onClick={()=>{setShowModal(false);setComment('');}}>Отмена</button><button className="btn btn-amber btn-sm" onClick={submitRequest} disabled={loading}>{loading?'Отправка...':'Отправить'}</button></div>
                </div>
            </div>)}
        </>);
        if(call.sv_request&&!call.sv_request_approved)return(
            <div className="sv-pending">
                <div className="tooltip-wrap">
                    <i className="fas fa-clock"></i>
                    <div className="tooltip-box">{call.sv_request_comment||'Запрос отправлен'}{call.sv_request_by_name?` · ${call.sv_request_by_name}`:''}</div>
                </div>
                <span>Ожидает</span>
            </div>
        );
        if(call.sv_request_approved)return(
            <div style={{display:'flex',alignItems:'center',gap:6}}>
                <div className="tooltip-wrap">
                    <i className="fas fa-check-circle" style={{color:'var(--green)'}}></i>
                    <div className="tooltip-box">Одобрено{call.sv_request_approved_by_name?`: ${call.sv_request_approved_by_name}`:''}</div>
                </div>
                <button onClick={e=>{e.stopPropagation();}} className="btn btn-primary btn-sm">Переоценить</button>
            </div>
        );
        return null;
    }

    /* ─────── MAIN APP ─────── */
    const App = () => {
        const [userName,setUserName]=useState(null);
        const [calls,setCalls]=useState([]);
        const [showEvaluationModal,setShowEvaluationModal]=useState(false);
        const [showLoginModal,setShowLoginModal]=useState(false);
        const [authChecked,setAuthChecked]=useState(false);
        const [userId,setUserId]=useState(null);
        const [userRole,setUserRole]=useState(null);
        const [directions,setDirections]=useState([]);
        const [operators,setOperators]=useState([]);
        const [selectedOperator,setSelectedOperator]=useState(null);
        const [selectedMonth,setSelectedMonth]=useState(new Date().toISOString().slice(0,7));
        const [expandedDetails,setExpandedDetails]=useState(null);
        const [editingEvaluation,setEditingEvaluation]=useState(null);
        const [isLoading,setIsLoading]=useState(false);
        const [loadingCallId,setLoadingCallId]=useState(null);
        const [operatorFromToken,setOperatorFromToken]=useState(null);
        const [supervisors,setSupervisors]=useState([]);
        const [selectedSupervisor,setSelectedSupervisor]=useState(null);
        const [showVersionsModal,setShowVersionsModal]=useState(false);
        const [versionHistory,setVersionHistory]=useState([]);
        const [fromDate,setFromDate]=useState(null);
        const [toDate,setToDate]=useState(null);
        const [viewMode,setViewMode]=useState('normal');
        const MAX_EVALUATIONS=20;

        const formatDateReadable=(dateStr)=>{
            if(!dateStr)return'-';
            try{let d=new Date(dateStr);if(isNaN(d))d=new Date(String(dateStr).replace(' ','T'));if(isNaN(d))return dateStr;
                return new Intl.DateTimeFormat('ru-RU',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}).format(d).replace(/\./g,'').replace(',','');}
            catch(e){return dateStr;}
        };

        const getLast12Months=()=>{const months=[];const currentDate=new Date();for(let i=0;i<12;i++){const date=new Date(currentDate.getFullYear(),currentDate.getMonth()-i,1);const year=date.getFullYear();const month=String(date.getMonth()+1).padStart(2,'0');months.push({value:`${year}-${month}`,label:date.toLocaleString('default',{month:'long',year:'numeric'})});}return months;};
        const monthOptions=getLast12Months();

        useEffect(()=>{
            let cancelled=false;
            const bootstrapAuth=async()=>{
                try{const response=await authFetch(`${API_BASE_URL}/api/auth/me`);const data=await readJsonSafe(response);const user=data?.user||data;
                    if(!cancelled&&response.ok&&data?.status==='success'&&user?.id){setUserId(user.id);setUserRole(user.role||null);setUserName(user.name||null);setShowLoginModal(false);}
                    else if(!cancelled)setShowLoginModal(true);
                }catch(err){if(!cancelled)setShowLoginModal(true);}
                finally{if(!cancelled)setAuthChecked(true);}
            };
            bootstrapAuth();
            return()=>{cancelled=true;};
        },[]);

        useEffect(()=>{
            if(userRole==='admin'&&userId){
                const fetchSupervisors=async()=>{
                    try{const response=await authFetch(`${API_BASE_URL}/api/admin/sv_list`,{headers:{'X-User-Id':userId}});const data=await response.json();if(data.status==='success')setSupervisors(data.sv_list||[]);}
                    catch(err){console.error('Error fetching supervisors:',err);}
                };
                fetchSupervisors();
            }
        },[userRole,userId]);

        useEffect(()=>{
            const params=new URLSearchParams(window.location.search);const token=params.get('token');
            if(token){try{const decodedToken=decodeURIComponent(token);const tokenData=JSON.parse(safeAtob(decodedToken));
                if(!tokenData.timestamp||Date.now()-tokenData.timestamp<300000){
                    setOperatorFromToken({id:tokenData.operatorId,name:tokenData.operatorName});
                    if(tokenData.month)setSelectedMonth(tokenData.month);if(tokenData.supervisorId)setSelectedSupervisor(tokenData.supervisorId);
                }
            }catch(e){console.error('Token error:',e);}finally{window.history.replaceState({},document.title,window.location.pathname);}}
        },[]);

        useEffect(()=>{if(operatorFromToken&&operators.length>0){const f=operators.find(op=>op.id===operatorFromToken.id);setSelectedOperator(f||null);setOperatorFromToken(null);}},[operators,operatorFromToken]);

        useEffect(()=>{
            if(!userId)return;
            setIsLoading(true);
            const fetchDirections=async()=>{try{const r=await authFetch(`${API_BASE_URL}/api/admin/directions`,{headers:{'X-User-Id':userId}});const d=await r.json();if(d.status==='success')setDirections(d.directions);}catch(err){console.error(err);}};
            const fetchOperators=async()=>{
                try{let url=`${API_BASE_URL}/api/sv/data?id=${userId}`;if(userRole==='admin'&&selectedSupervisor)url=`${API_BASE_URL}/api/sv/data?id=${selectedSupervisor}`;
                    const r=await authFetch(url,{headers:{'X-User-Id':userId}});const d=await r.json();if(d.status==='success')setOperators(d.operators);}
                catch(err){console.error(err);}
            };
            Promise.all([fetchDirections(),fetchOperators()]).finally(()=>setIsLoading(false));
        },[userId,userRole,selectedSupervisor]);

        const fetchEvaluations=async()=>{
            if(!selectedOperator||!userId){setCalls([]);return;}
            setIsLoading(true);
            try{
                const response=await authFetch(`${API_BASE_URL}/api/call_evaluations?operator_id=${selectedOperator.id}`,{headers:{'X-User-Id':userId}});
                const data=await response.json();
                if(data.status==='success'){
                    const updatedCalls=await Promise.all(data.evaluations.map(async(evaluation)=>({
                        id:evaluation.id,fileName:`Call ${evaluation.phone_number}`,
                        totalScore:evaluation.score!=null?parseFloat(evaluation.score).toFixed(2):null,
                        date:evaluation.evaluation_date?(evaluation.evaluation_date.split('T')[0]||evaluation.evaluation_date):'',
                        phoneNumber:evaluation.phone_number,combinedComment:evaluation.comment,
                        appeal_date:evaluation.appeal_date||'-',
                        selectedDirection:evaluation.direction?.name||selectedOperator?.direction||'-',
                        directionId:evaluation.direction?.id??null,
                        directions:[{name:evaluation.direction?.name||'-',hasFileUpload:evaluation.direction?.hasFileUpload??true,criteria:evaluation.direction?.criteria||[]}],
                        scores:evaluation.scores||[],criterionComments:evaluation.criterion_comments||[],
                        audioUrl:null,isDraft:evaluation.is_draft,assignedMonth:evaluation.month,
                        isCorrection:evaluation.is_correction||false,is_imported:evaluation.is_imported||false,
                        sv_request:!!evaluation.sv_request,sv_request_comment:evaluation.sv_request_comment||null,
                        sv_request_by:evaluation.sv_request_by||null,sv_request_by_name:evaluation.sv_request_by_name||null,
                        sv_request_at:evaluation.sv_request_at||null,sv_request_approved:!!evaluation.sv_request_approved,
                        sv_request_approved_by:evaluation.sv_request_approved_by||null,sv_request_approved_by_name:evaluation.sv_request_approved_by_name||null,
                        sv_request_approved_at:evaluation.sv_request_approved_at||null,_rawEvaluation:evaluation
                    })));
                    setCalls(updatedCalls);
                }
            }catch(err){if(err.name!=='AbortError')console.error(err);}
            finally{setIsLoading(false);}
        };

        useEffect(()=>{
            if(!userId||!selectedOperator){setCalls([]);return;}
            const controller=new AbortController();
            fetchEvaluations();
            return()=>controller.abort();
        },[userId,selectedOperator,directions]);

        useEffect(()=>{setFromDate(null);setToDate(null);},[selectedMonth]);
        useEffect(()=>{const ec=calls.filter(c=>c.assignedMonth===selectedMonth&&c.date.slice(0,7)!==selectedMonth).length;if(viewMode==='extra'&&ec===0)setViewMode('normal');},[calls,selectedMonth,viewMode]);

        const handleLogin=(user)=>{if(!user||!user.id){setShowLoginModal(true);return false;}setUserId(user.id);setUserRole(user.role||null);setUserName(user.name||null);setShowLoginModal(false);return true;};
        const handleLogout=()=>{setUserId(null);setUserRole(null);setUserName(null);setOperators([]);setSelectedOperator(null);setDirections([]);setCalls([]);setSupervisors([]);setSelectedSupervisor(null);setExpandedDetails(null);setShowEvaluationModal(false);setEditingEvaluation(null);setShowVersionsModal(false);setVersionHistory([]);setShowLoginModal(true);};

        const handleEvaluateCall=(evaluationData)=>{
            setCalls((prevCalls)=>{
                if(!evaluationData)return prevCalls.filter(c=>c.id!==editingEvaluation?.id);
                const newCall={id:evaluationData.id,fileName:`Call ${evaluationData.phoneNumber}`,scores:evaluationData.scores,criterionComments:evaluationData.criterionComments,combinedComment:evaluationData.comment,totalScore:evaluationData.totalScore,date:new Date().toISOString().slice(0,10),audioUrl:evaluationData.audioUrl,isDraft:evaluationData.isDraft,selectedDirection:evaluationData.selectedDirection,directionId:evaluationData.directionId??selectedOperator?.direction_id,directions:evaluationData.directions,phoneNumber:evaluationData.phoneNumber,assignedMonth:evaluationData.assignedMonth,direction_id:evaluationData.directionId??selectedOperator?.direction_id,isCorrection:evaluationData.isCorrection,appeal_date:evaluationData.appeal_date,is_imported:evaluationData.is_imported||false,sv_request:false,sv_request_comment:null,sv_request_by:null,sv_request_by_name:null,sv_request_at:null,sv_request_approved:false,sv_request_approved_by:null,sv_request_approved_by_name:null,sv_request_approved_at:null};
                let updatedCalls=evaluationData.isCorrection?prevCalls.filter(c=>c.id!==evaluationData.id&&c.id!==evaluationData.previous_version_id):prevCalls.filter(c=>c.id!==newCall.id);
                return[...updatedCalls,newCall];
            });
            if(evaluationData?.isCorrection&&evaluationData?.id){delete audioUrlCache[evaluationData.id];if(evaluationData.previous_version_id)delete audioUrlCache[evaluationData.previous_version_id];}
            setEditingEvaluation(null);
            if(!evaluationData?.isDraft)fetchEvaluations();
        };

        const handleSelectCall=async(callId)=>{
            const call=calls.find(c=>c.id===callId);if(!call)return;
            if(call.isDraft){setEditingEvaluation(call);setShowEvaluationModal(true);return;}
            if(expandedDetails!==callId){
                setLoadingCallId(callId);
                try{if(!call.audioUrl&&call.directions?.[0]?.hasFileUpload){const url=await getAudioUrlWithAuth(call.id,userId);if(url)setCalls(prev=>prev.map(c=>c.id===call.id?{...c,audioUrl:url}:c));}setExpandedDetails(callId);}
                catch(err){console.error(err);}
                finally{setLoadingCallId(null);}
            }else setExpandedDetails(null);
        };

        const deleteImportedCall=async(callId)=>{
            if(!confirm('Удалить импортированный звонок?'))return;setIsLoading(true);
            try{const r=await authFetch(`${API_BASE_URL}/api/call_evaluations/${callId}`,{method:'DELETE',headers:{'Content-Type':'application/json','X-User-Id':userId}});const d=await r.json();if(!r.ok)throw new Error(d.error||JSON.stringify(d));setCalls(prev=>prev.filter(c=>c.id!==callId));alert('Удалено');}
            catch(err){alert('Ошибка: '+(err.message||'unknown'));}
            finally{setIsLoading(false);}
        };

        const monthStart=`${selectedMonth}-01`;
        const lastDay=new Date(parseInt(selectedMonth.slice(0,4)),parseInt(selectedMonth.slice(5,7)),0).getDate();
        const monthEnd=`${selectedMonth}-${lastDay.toString().padStart(2,'0')}`;

        const callsByMonth=calls.filter(c=>c.assignedMonth===selectedMonth);
        let displayedCalls=callsByMonth;
        if(viewMode==='normal')displayedCalls=displayedCalls.filter(c=>(!fromDate||c.date>=fromDate)&&(!toDate||c.date<=toDate));
        else displayedCalls=displayedCalls.filter(c=>c.date.slice(0,7)!==selectedMonth);
        const hasExtra=callsByMonth.filter(c=>c.date.slice(0,7)!==selectedMonth).length>0;
        const isMaxEvaluationsReached=callsByMonth.filter(c=>!c.isDraft&&!c.is_imported).length>=MAX_EVALUATIONS;
        const evaluationCount=displayedCalls.filter(c=>!c.isDraft&&!c.is_imported).length;
        const averageScore=evaluationCount>0?displayedCalls.filter(c=>!c.isDraft&&!c.is_imported).reduce((sum,c)=>sum+parseFloat(c.totalScore),0)/evaluationCount:0;

        if(!authChecked)return(<div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center',background:'var(--bg)'}}>
            <div style={{fontSize:'13px',color:'var(--muted)'}}>Проверка сессии...</div>
        </div>);

        return (
            <div className="app-wrap">
                {/* Header */}
                <header className="header">
                    <div style={{display:'flex',alignItems:'center',gap:10}}>
                        <div style={{width:8,height:8,borderRadius:'50%',background:'var(--indigo)'}}></div>
                        <span className="header-title">Оценки операторов</span>
                    </div>
                    <div className="header-right">
                        {userName&&<span className="welcome-text">{userName}</span>}
                        <button className="btn btn-ghost btn-sm" onClick={handleLogout}><i className="fa-solid fa-arrow-right-from-bracket"></i> Выход</button>
                    </div>
                </header>

                {/* Main */}
                <div className="card">
                    {/* Controls bar */}
                    <div style={{padding:'16px 20px',borderBottom:'1px solid var(--border)',display:'flex',flexWrap:'wrap',gap:16,alignItems:'flex-end'}}>
                        {userRole==='admin'&&(
                            <div><div className="ctrl-label">Супервайзер</div>
                                <select className="ctrl-select" value={selectedSupervisor||''} onChange={e=>{const sv=supervisors.find(s=>s.id===parseInt(e.target.value));setSelectedSupervisor(sv?sv.id:null);setSelectedOperator(null);setOperators([]);setCalls([]);setIsLoading(true);}}>
                                    <option value="">Выбрать...</option>
                                    {supervisors.filter(s=>s.status!=='fired').sort((a,b)=>a.name.localeCompare(b.name,'ru',{sensitivity:'base'})).map(s=><option key={s.id} value={s.id}>{s.name}</option>)}
                                    {supervisors.filter(s=>s.status==='fired').sort((a,b)=>a.name.localeCompare(b.name,'ru',{sensitivity:'base'})).map(s=><option key={s.id} value={s.id} style={{color:'var(--muted)'}}>({s.name})</option>)}
                                </select>
                            </div>
                        )}
                        <div><div className="ctrl-label">Оператор</div>
                            <select className="ctrl-select" value={selectedOperator?.id||''} onChange={e=>{const op=operators.find(o=>o.id===parseInt(e.target.value))||null;setSelectedOperator(op);setCalls([]);setExpandedDetails(null);setIsLoading(true);}}>
                                <option value="">Выбрать...</option>
                                {operators.filter(o=>o.status!=='fired').sort((a,b)=>a.name.localeCompare(b.name,'ru',{sensitivity:'base'})).map(o=><option key={o.id} value={o.id}>{o.name}</option>)}
                                {operators.filter(o=>o.status==='fired').sort((a,b)=>a.name.localeCompare(b.name,'ru',{sensitivity:'base'})).map(o=><option key={o.id} value={o.id} style={{color:'var(--muted)'}}>({o.name})</option>)}
                            </select>
                        </div>
                        <div><div className="ctrl-label">Месяц</div>
                            <select className="ctrl-select" value={selectedMonth} onChange={e=>setSelectedMonth(e.target.value)}>
                                {monthOptions.map(o=><option key={o.value} value={o.value}>{o.label}</option>)}
                            </select>
                        </div>
                        {userRole==='admin'&&<DateRangePicker minDate={monthStart} maxDate={monthEnd} setFromDate={setFromDate} setToDate={setToDate}/>}
                        <div style={{marginLeft:'auto',display:'flex',gap:8,alignItems:'center'}}>
                            {userRole==='admin'&&(viewMode==='extra'||hasExtra)&&(
                                <button className="btn btn-amber btn-sm btn-round" onClick={()=>setViewMode(viewMode==='normal'?'extra':'normal')}>
                                    {viewMode==='normal'?'Показать внешние':'К текущим'}
                                </button>
                            )}
                            {viewMode==='normal'&&(
                                <button className="btn btn-primary btn-round" onClick={()=>{setEditingEvaluation(null);setShowEvaluationModal(true);}} disabled={!selectedOperator||isMaxEvaluationsReached}>
                                    <i className="fa-solid fa-plus"></i> Добавить оценку
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Stats */}
                    {selectedOperator&&(
                        <div style={{padding:'16px 20px',borderBottom:'1px solid var(--border)',display:'flex',gap:12}}>
                            <div className="stat-card" style={{maxWidth:200}}>
                                <div className="stat-label">Оценки</div>
                                <div className="stat-value">{evaluationCount}<span style={{fontSize:'16px',color:'var(--muted)',fontWeight:400,fontFamily:'Outfit'}}>/{MAX_EVALUATIONS}</span></div>
                                <div className="stat-bar"><div className="stat-bar-fill" style={{width:`${(evaluationCount/MAX_EVALUATIONS)*100}%`,background:'var(--indigo)'}}></div></div>
                            </div>
                            <div className="stat-card" style={{maxWidth:200}}>
                                <div className="stat-label">Средний балл</div>
                                <div className="stat-value" style={{color:averageScore>=80?'var(--green)':averageScore>=60?'var(--amber)':'var(--red)'}}>{evaluationCount>0?averageScore.toFixed(1):'—'}</div>
                                <div className="stat-bar"><div className="stat-bar-fill" style={{width:`${averageScore}%`,background:averageScore>=80?'var(--green)':averageScore>=60?'var(--amber)':'var(--red)'}}></div></div>
                            </div>
                            <div className="stat-card" style={{maxWidth:200}}>
                                <div className="stat-label">Оператор</div>
                                <div style={{fontSize:'15px',fontWeight:600,marginTop:4}}>{selectedOperator.name}</div>
                                <div className="stat-sub">{monthOptions.find(m=>m.value===selectedMonth)?.label}</div>
                            </div>
                        </div>
                    )}

                    {/* Table */}
                    <div style={{padding:'0'}}>
                        {displayedCalls.length===0?(
                            isLoading?(
                                <table><thead><tr><th>№</th><th>Статус</th><th>Направление</th><th>Телефон</th><th>Балл</th><th>Дата обр.</th><th>Дата оц.</th><th></th></tr></thead>
                                <tbody>{[...Array(4)].map((_,i)=><tr key={i}>{[...Array(8)].map((_,j)=><td key={j}><div className="skel" style={{width:['40px','80px','120px','100px','50px','110px','110px','80px'][j]||'80px'}}></div></td>)}</tr>)}</tbody></table>
                            ):(
                                <div className="empty-state">
                                    <div className="empty-state-icon">📋</div>
                                    <div className="empty-state-title">Нет оценок</div>
                                    <div className="empty-state-text">Выберите оператора и месяц или добавьте новую оценку</div>
                                </div>
                            )
                        ):(
                            <div className="tbl-wrap" style={{borderRadius:0,border:'none',borderTop:'1px solid var(--border)'}}>
                                <table>
                                    <thead><tr>
                                        <th style={{width:40}}>№</th>
                                        <th style={{width:100}}>Статус</th>
                                        <th>Направление</th>
                                        <th>Телефон</th>
                                        <th style={{width:80}}>Балл</th>
                                        <th>Дата обр.</th>
                                        <th>Дата оц.</th>
                                        <th style={{width:220}}>Действия</th>
                                    </tr></thead>
                                    <tbody>
                                        {displayedCalls.map((call,index)=>(
                                            <React.Fragment key={call.id}>
                                                <tr className={`${!call.is_imported?'clickable':''} ${expandedDetails===call.id?'expanded':''}`} onClick={!call.is_imported?()=>handleSelectCall(call.id):null}>
                                                    <td><span style={{fontFamily:'DM Mono',fontSize:'12px',color:'var(--muted)'}}>{index+1}</span></td>
                                                    <td>
                                                        {loadingCallId===call.id?<span style={{color:'var(--muted)',fontSize:'12px'}}>...</span>:(
                                                            call.isDraft
                                                                ?<span className="badge badge-indigo"><span className="badge-dot"></span>Черновик</span>
                                                                :call.is_imported
                                                                    ?<span className="badge badge-amber"><span className="badge-dot"></span>Не оценён</span>
                                                                    :<span className="badge badge-green"><span className="badge-dot"></span>Оценён</span>
                                                        )}
                                                    </td>
                                                    <td style={{color:'var(--muted)',fontSize:'12px'}}>{call.selectedDirection||'-'}</td>
                                                    <td><span style={{fontFamily:'DM Mono',fontSize:'12px'}}>{call.phoneNumber||'-'}</span></td>
                                                    <td>
                                                        {call.totalScore!=null
                                                            ?<span className="score-pill" style={{color:parseFloat(call.totalScore)>=80?'var(--green)':parseFloat(call.totalScore)>=60?'var(--amber)':'var(--red)'}}>{Math.round(call.totalScore)}</span>
                                                            :<span style={{color:'var(--muted-2)'}}>—</span>}
                                                    </td>
                                                    <td style={{fontSize:'12px',color:'var(--muted)'}}>{formatDateReadable(call.appeal_date)}</td>
                                                    <td style={{fontSize:'12px',color:'var(--muted)'}}>{formatDateReadable(call._rawEvaluation?.evaluation_date||call.date)}</td>
                                                    <td onClick={e=>e.stopPropagation()}>
                                                        <div style={{display:'flex',gap:6,alignItems:'center',justifyContent:'flex-end'}}>
                                                            {call.is_imported?(<>
                                                                <button className="btn btn-green btn-sm" onClick={e=>{e.stopPropagation();setEditingEvaluation(call);setShowEvaluationModal(true);}}>Оценить</button>
                                                                {userRole==='admin'&&<button className="btn btn-red btn-sm" onClick={e=>{e.stopPropagation();deleteImportedCall(call.id);}}>Удалить</button>}
                                                            </>):(<>
                                                                <SvRequestButton call={call} userId={userId} userRole={userRole} fetchEvaluations={fetchEvaluations}/>
                                                                {userRole==='admin'&&!call.isDraft&&(<>
                                                                    <button className="btn btn-primary btn-sm" onClick={e=>{e.stopPropagation();setEditingEvaluation({...call,isReevaluation:true});setShowEvaluationModal(true);}}>Переоценить</button>
                                                                    {call.isCorrection&&(
                                                                        <button className="btn btn-ghost btn-sm" onClick={async e=>{e.stopPropagation();try{const r=await authFetch(`${API_BASE_URL}/api/call_versions/${call.id}`,{headers:{'X-User-Id':userId}});const d=await r.json();if(d.status==='success'){setVersionHistory(d.versions);setShowVersionsModal(true);}}catch(err){console.error(err);}}}>
                                                                            <i className="fa-solid fa-clock-rotate-left"></i>
                                                                        </button>
                                                                    )}
                                                                </>)}
                                                            </>)}
                                                        </div>
                                                    </td>
                                                </tr>
                                                {expandedDetails===call.id&&(
                                                    <tr>
                                                        <td colSpan="8" style={{padding:0}}>
                                                            <div className="detail-wrap fade-up">
                                                                <div style={{display:'flex',gap:24,marginBottom:12,flexWrap:'wrap'}}>
                                                                    <span style={{fontSize:'12px',color:'var(--muted)'}}><strong style={{color:'var(--text)'}}>Оценщик:</strong> {call._rawEvaluation?.evaluator||'-'}</span>
                                                                    <span style={{fontSize:'12px',color:'var(--muted)'}}><strong style={{color:'var(--text)'}}>Дата обр.:</strong> {formatDateReadable(call._rawEvaluation?.appeal_date||call.appeal_date)}</span>
                                                                    <span style={{fontSize:'12px',color:'var(--muted)'}}><strong style={{color:'var(--text)'}}>Дата оц.:</strong> {formatDateReadable(call._rawEvaluation?.evaluation_date||call.date)}</span>
                                                                </div>
                                                                {call.audioUrl&&call.directions[0]?.hasFileUpload&&(
                                                                    <div style={{marginBottom:12}}>
                                                                        <audio controls style={{width:'100%',maxWidth:400,height:'36px'}}><source src={call.audioUrl} type="audio/mpeg"/>Ваш браузер не поддерживает audio.</audio>
                                                                    </div>
                                                                )}
                                                                {call.directions&&call.directions.length>0&&call.directions[0].criteria.length>0&&(
                                                                    <table className="detail-sub-tbl">
                                                                        <thead><tr><th>Критерий</th><th style={{width:80}}>Вес</th><th style={{width:100}}>Оценка</th><th>Комментарий</th></tr></thead>
                                                                        <tbody>
                                                                            {call.directions[0].criteria.map((c,i)=>(
                                                                                <tr key={i}>
                                                                                    <td style={{fontSize:'12px'}}>{c.name}</td>
                                                                                    <td style={{fontSize:'11px',color:'var(--muted)',fontFamily:'DM Mono'}}>{c.isCritical?'Крит.':c.weight}</td>
                                                                                    <td>
                                                                                        <span style={{fontSize:'11px',fontWeight:600,color:call.scores[i]==='Correct'||call.scores[i]==='N/A'?'var(--green)':call.scores[i]==='Deficiency'?'var(--amber)':'var(--red)'}}>
                                                                                            {call.scores[i]||'Correct'}
                                                                                        </span>
                                                                                    </td>
                                                                                    <td style={{fontSize:'12px',color:'var(--muted)'}}>{call.criterionComments[i]||'-'}</td>
                                                                                </tr>
                                                                            ))}
                                                                        </tbody>
                                                                    </table>
                                                                )}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                )}
                                            </React.Fragment>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>

                    {/* Footer */}
                    {selectedOperator&&displayedCalls.length>0&&(
                        <div style={{padding:'12px 20px',borderTop:'1px solid var(--border)',fontSize:'12px',color:'var(--muted)'}}>
                            {displayedCalls.length} записей · {monthOptions.find(m=>m.value===selectedMonth)?.label}
                        </div>
                    )}
                </div>

                {/* Modals */}
                <LoginModal isOpen={showLoginModal} onClose={()=>setShowLoginModal(false)} onLogin={handleLogin}/>
                <EvaluationModal isOpen={showEvaluationModal} onClose={()=>{setShowEvaluationModal(false);setEditingEvaluation(null);}} onSubmit={handleEvaluateCall} directions={directions} operator={selectedOperator} selectedMonth={selectedMonth} userId={userId} userName={userName} existingEvaluation={editingEvaluation}/>

                {showVersionsModal&&(
                    <div className="modal-overlay" onClick={()=>setShowVersionsModal(false)}>
                        <div className="modal-box" style={{maxWidth:700}} onClick={e=>e.stopPropagation()}>
                            <div className="modal-header">
                                <div className="modal-title">История оценки</div>
                                <button className="modal-close" onClick={()=>setShowVersionsModal(false)}><i className="fa-solid fa-xmark"></i></button>
                            </div>
                            <div className="modal-body">
                                {versionHistory.map((v,idx)=>(
                                    <div key={idx} className="version-card">
                                        <div style={{display:'flex',justifyContent:'space-between',marginBottom:10}}>
                                            <span style={{fontSize:'13px',fontWeight:700}}>Версия {versionHistory.length-idx}</span>
                                            <span style={{fontFamily:'DM Mono',fontSize:'12px',color:'var(--muted)'}}>{v.evaluation_date?.split('T')[0]}</span>
                                        </div>
                                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,fontSize:'13px'}}>
                                            <div><span style={{color:'var(--muted)'}}>Балл:</span> <strong style={{fontFamily:'DM Mono'}}>{v.score}</strong></div>
                                            <div><span style={{color:'var(--muted)'}}>Оценщик:</span> {v.evaluator_name}</div>
                                            <div><span style={{color:'var(--muted)'}}>Телефон:</span> <span style={{fontFamily:'DM Mono'}}>{v.phone_number}</span></div>
                                            <div><span style={{color:'var(--muted)'}}>Дата обр.:</span> {v.appeal_date||'-'}</div>
                                        </div>
                                        {v.comment&&<div style={{marginTop:8,fontSize:'12px',color:'var(--muted)',borderTop:'1px solid var(--border)',paddingTop:8}}>{v.comment}</div>}
                                    </div>
                                ))}
                            </div>
                            <div className="modal-footer"><div></div><button className="btn btn-ghost" onClick={()=>setShowVersionsModal(false)}>Закрыть</button></div>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>