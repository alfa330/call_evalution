<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оценки операторов</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.3.1/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.3.1/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.25.6/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600&family=Geist+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg: #f7f7f5;
            --surface: #ffffff;
            --surface-2: #f2f2f0;
            --border: #e5e5e2;
            --border-strong: #d0d0cc;
            --text: #1a1a18;
            --text-2: #6b6b67;
            --text-3: #9b9b96;
            --accent: #2563eb;
            --accent-light: #eff4ff;
            --accent-hover: #1d4ed8;
            --green: #16a34a;
            --green-light: #f0fdf4;
            --red: #dc2626;
            --red-light: #fef2f2;
            --amber: #d97706;
            --amber-light: #fffbeb;
            --radius: 8px;
            --radius-lg: 12px;
            --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.04);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.06);
            --font: 'Geist', -apple-system, sans-serif;
            --font-mono: 'Geist Mono', monospace;
            --transition: 150ms ease;
        }

        body {
            font-family: var(--font);
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* ── Layout ── */
        #root { min-height: 100vh; }

        .app { max-width: 1280px; margin: 0 auto; padding: 24px; }

        /* ── Header ── */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
        }
        .header-logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-logo-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--accent);
        }
        .header h1 {
            font-size: 15px;
            font-weight: 600;
            letter-spacing: -0.01em;
            color: var(--text);
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .header-user {
            font-size: 13px;
            color: var(--text-2);
            font-weight: 500;
        }

        /* ── Buttons ── */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 14px;
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 500;
            font-family: var(--font);
            cursor: pointer;
            border: 1px solid transparent;
            transition: all var(--transition);
            white-space: nowrap;
            outline: none;
        }
        .btn:focus-visible { box-shadow: 0 0 0 3px var(--accent-light); }
        .btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); }
        .btn-primary:hover { background: var(--accent-hover); border-color: var(--accent-hover); }
        .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-secondary { background: var(--surface); color: var(--text); border-color: var(--border-strong); }
        .btn-secondary:hover { background: var(--surface-2); }
        .btn-danger { background: var(--red-light); color: var(--red); border-color: #fca5a5; }
        .btn-danger:hover { background: #fee2e2; }
        .btn-ghost { background: transparent; color: var(--text-2); border-color: transparent; }
        .btn-ghost:hover { background: var(--surface-2); color: var(--text); }
        .btn-green { background: var(--green-light); color: var(--green); border-color: #bbf7d0; }
        .btn-green:hover { background: #dcfce7; }
        .btn-amber { background: var(--amber-light); color: var(--amber); border-color: #fde68a; }
        .btn-amber:hover { background: #fef3c7; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .btn-lg { padding: 10px 20px; font-size: 14px; }

        /* ── Form controls ── */
        .input, .select, .textarea {
            width: 100%;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-strong);
            border-radius: var(--radius);
            font-family: var(--font);
            font-size: 13px;
            color: var(--text);
            transition: border-color var(--transition), box-shadow var(--transition);
            outline: none;
        }
        .input:focus, .select:focus, .textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }
        .input::placeholder, .textarea::placeholder { color: var(--text-3); }
        .input:read-only { background: var(--surface-2); color: var(--text-2); cursor: default; }
        .select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b6b67' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; padding-right: 32px; }
        .textarea { resize: vertical; min-height: 80px; line-height: 1.5; }
        .label { font-size: 12px; font-weight: 500; color: var(--text-2); margin-bottom: 5px; display: block; letter-spacing: 0.01em; }
        .field { margin-bottom: 16px; }
        .error-text { font-size: 12px; color: var(--red); margin-top: 4px; }

        /* ── Card ── */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
        }
        .card-body { padding: 24px; }

        /* ── Main panel ── */
        .main-panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); }
        .panel-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }
        .panel-title { font-size: 14px; font-weight: 600; color: var(--text); }

        /* ── Stats bar ── */
        .stats-bar {
            display: flex;
            gap: 1px;
            background: var(--border);
            border-bottom: 1px solid var(--border);
            overflow: hidden;
        }
        .stat-item {
            flex: 1;
            padding: 14px 20px;
            background: var(--surface);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .stat-icon {
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }
        .stat-icon.blue { background: var(--accent-light); color: var(--accent); }
        .stat-icon.green { background: var(--green-light); color: var(--green); }
        .stat-value { font-size: 18px; font-weight: 600; color: var(--text); letter-spacing: -0.02em; font-family: var(--font-mono); }
        .stat-label { font-size: 11px; color: var(--text-2); font-weight: 500; letter-spacing: 0.02em; text-transform: uppercase; }

        /* ── Filters ── */
        .filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .filter-group { display: flex; flex-direction: column; min-width: 160px; }
        .filter-group .select { min-width: 160px; }

        /* ── Table ── */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead th {
            padding: 10px 16px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-2);
            letter-spacing: 0.05em;
            text-transform: uppercase;
            background: var(--surface-2);
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        thead th:first-child { border-radius: 0; padding-left: 20px; }
        tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background var(--transition);
        }
        tbody tr:last-child { border-bottom: none; }
        tbody tr.clickable:hover { background: var(--surface-2); cursor: pointer; }
        tbody tr.expanded { background: var(--accent-light) !important; }
        tbody tr.imported { background: #fffbf0; }
        tbody td {
            padding: 12px 16px;
            font-size: 13px;
            color: var(--text);
            vertical-align: middle;
        }
        tbody td:first-child { padding-left: 20px; color: var(--text-2); font-variant-numeric: tabular-nums; }

        /* ── Badge ── */
        .badge {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 2px 8px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.01em;
        }
        .badge-green { background: var(--green-light); color: var(--green); }
        .badge-amber { background: var(--amber-light); color: var(--amber); }
        .badge-blue { background: var(--accent-light); color: var(--accent); }
        .badge-dot { width: 5px; height: 5px; border-radius: 50%; background: currentColor; }

        /* ── Score chip ── */
        .score-chip {
            font-family: var(--font-mono);
            font-size: 13px;
            font-weight: 500;
        }
        .score-high { color: var(--green); }
        .score-mid { color: var(--amber); }
        .score-low { color: var(--red); }

        /* ── Expanded row ── */
        .expanded-row td { padding: 0; background: var(--surface); }
        .expanded-content { padding: 20px 24px 24px; border-top: 2px solid var(--accent); }
        .expanded-content h4 { font-size: 13px; font-weight: 600; color: var(--text-2); letter-spacing: 0.04em; text-transform: uppercase; margin-bottom: 14px; }
        .expanded-meta { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 16px; font-size: 13px; }
        .expanded-meta-item { display: flex; gap: 6px; }
        .expanded-meta-item strong { color: var(--text-2); font-weight: 500; }

        /* ── Criteria detail table ── */
        .crit-table { width: 100%; border-collapse: collapse; margin-bottom: 16px; }
        .crit-table th { padding: 8px 12px; font-size: 11px; font-weight: 600; color: var(--text-2); text-transform: uppercase; letter-spacing: 0.04em; background: var(--surface-2); border: 1px solid var(--border); text-align: left; }
        .crit-table td { padding: 8px 12px; font-size: 13px; border: 1px solid var(--border); vertical-align: top; }
        .score-correct { color: var(--green); font-weight: 500; }
        .score-error { color: var(--red); font-weight: 500; }
        .score-na { color: var(--text-2); font-weight: 500; }

        /* ── Modal backdrop ── */
        .modal-backdrop {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            z-index: 100;
            padding: 24px;
            animation: fadeIn 0.12s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

        /* ── Modal box ── */
        .modal {
            background: var(--surface);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 720px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.15s ease;
            border: 1px solid var(--border);
        }
        .modal-wide { max-width: 900px; }
        .modal-header {
            padding: 18px 24px;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0;
        }
        .modal-header h2 { font-size: 15px; font-weight: 600; color: var(--text); }
        .modal-header-sub { font-size: 12px; color: var(--text-2); margin-top: 1px; }
        .modal-body { padding: 20px 24px; overflow-y: auto; flex: 1; }
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex; align-items: center; justify-content: flex-end;
            gap: 8px;
            flex-shrink: 0;
            background: var(--surface-2);
        }

        /* ── Section divider ── */
        .section-divider {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-2);
            letter-spacing: 0.06em;
            text-transform: uppercase;
            padding: 14px 0 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }

        /* ── Criterion card ── */
        .crit-card {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 8px;
            transition: border-color var(--transition);
        }
        .crit-card:hover { border-color: var(--border-strong); }
        .crit-card.is-error { border-color: #fca5a5; }
        .crit-card.is-correct { border-color: var(--border); }
        .crit-card-header {
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--surface);
        }
        .crit-card-name {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
        }
        .crit-card-name.critical { color: var(--red); }
        .crit-weight {
            font-size: 11px;
            color: var(--text-2);
            font-family: var(--font-mono);
            font-weight: 500;
        }
        .crit-weight.critical { color: var(--red); }
        .crit-card-body { padding: 0 14px 12px; background: var(--surface); }
        .crit-comment-toggle { color: var(--text-3); cursor: pointer; transition: color var(--transition); padding: 2px; }
        .crit-comment-toggle:hover { color: var(--text-2); }
        .crit-comment-toggle.active { color: var(--accent); }
        .crit-info-btn { color: var(--text-3); cursor: pointer; transition: color var(--transition); padding: 2px; }
        .crit-info-btn:hover { color: var(--accent); }

        /* ── Score toggle buttons ── */
        .score-toggles { display: flex; gap: 4px; flex-wrap: wrap; }
        .score-toggle {
            padding: 4px 12px;
            border-radius: 100px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid var(--border-strong);
            background: var(--surface-2);
            color: var(--text-2);
            transition: all var(--transition);
            font-family: var(--font);
        }
        .score-toggle:hover { border-color: var(--border-strong); background: var(--bg); }
        .score-toggle.active-correct { background: var(--green-light); color: var(--green); border-color: #bbf7d0; }
        .score-toggle.active-na { background: var(--surface-2); color: var(--text-2); border-color: var(--border-strong); }
        .score-toggle.active-error { background: var(--red-light); color: var(--red); border-color: #fca5a5; }
        .score-toggle.active-incorrect { background: var(--red-light); color: var(--red); border-color: #fca5a5; }
        .score-toggle.active-deficiency { background: var(--amber-light); color: var(--amber); border-color: #fde68a; }

        /* ── Score summary bar ── */
        .score-summary {
            padding: 12px 16px;
            background: var(--surface-2);
            border-top: 1px solid var(--border);
            border-radius: 0 0 var(--radius) var(--radius);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
        }
        .score-summary-val {
            font-family: var(--font-mono);
            font-weight: 600;
            font-size: 16px;
            color: var(--text);
        }

        /* ── Info panel ── */
        .info-panel {
            position: fixed;
            top: 0; right: 0;
            width: 360px;
            height: 100%;
            background: var(--surface);
            border-left: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            z-index: 200;
            display: flex;
            flex-direction: column;
            animation: slideIn 0.2s ease;
        }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .info-panel-header { padding: 16px 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .info-panel-title { font-size: 13px; font-weight: 600; color: var(--text); }
        .info-panel-body { padding: 16px 18px; overflow-y: auto; flex: 1; font-size: 13px; line-height: 1.7; color: var(--text-2); }
        .info-panel-body p { margin-bottom: 8px; }
        .info-panel-body ol { padding-left: 18px; margin-bottom: 8px; }
        .info-panel-body ul { padding-left: 18px; margin-bottom: 8px; }
        .info-panel-body li { margin-bottom: 4px; }

        /* ── Audio player ── */
        .audio-wrap { background: var(--surface-2); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px 14px; margin-bottom: 14px; }
        .audio-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-2); margin-bottom: 8px; }
        audio { width: 100%; height: 32px; }
        audio::-webkit-media-controls-panel { background: var(--surface-2); }

        /* ── Empty state ── */
        .empty-state {
            padding: 60px 20px;
            text-align: center;
        }
        .empty-state-icon { font-size: 32px; margin-bottom: 12px; color: var(--text-3); }
        .empty-state h3 { font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 6px; }
        .empty-state p { font-size: 13px; color: var(--text-2); max-width: 320px; margin: 0 auto; }

        /* ── Skeleton ── */
        .skeleton { background: var(--surface-2); border-radius: 4px; animation: pulse 1.5s ease infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* ── Panel footer ── */
        .panel-footer {
            padding: 14px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--surface-2);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }
        .panel-footer-info { font-size: 12px; color: var(--text-2); }

        /* ── Spinner ── */
        .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ── Tooltip ── */
        .tooltip-wrap { position: relative; display: inline-flex; align-items: center; }
        .tooltip-wrap:hover .tooltip-box { opacity: 1; visibility: visible; transform: translateY(0); }
        .tooltip-box {
            position: absolute; bottom: calc(100% + 8px); left: 50%;
            transform: translateX(-50%) translateY(4px);
            background: #1a1a18; color: #fff;
            font-size: 12px; padding: 6px 10px;
            border-radius: 6px; white-space: pre-wrap;
            width: 240px; z-index: 300;
            opacity: 0; visibility: hidden;
            transition: all var(--transition);
            pointer-events: none;
        }

        /* ── Date range picker overrides ── */
        .flatpickr-calendar { border-radius: var(--radius-lg) !important; border: 1px solid var(--border) !important; box-shadow: var(--shadow-md) !important; }

        /* ── Two col grid ── */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        @media (max-width: 600px) { .grid-2 { grid-template-columns: 1fr; } }

        /* ── Version history item ── */
        .version-item { border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; }
        .version-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .version-badge { font-size: 11px; font-weight: 600; background: var(--accent-light); color: var(--accent); padding: 2px 8px; border-radius: 100px; }
        .version-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 12px; color: var(--text-2); }
        .version-grid strong { color: var(--text); font-weight: 500; display: block; font-size: 13px; }

        /* ── Request modal ── */
        .request-modal { max-width: 440px; }

        /* ── Directions selector ── */
        .dir-tabs { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 16px; }
        .dir-tab {
            padding: 6px 14px;
            border-radius: 100px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid var(--border-strong);
            background: var(--surface-2);
            color: var(--text-2);
            transition: all var(--transition);
        }
        .dir-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .dir-tab:hover:not(.active) { background: var(--bg); }

        /* ── Duration warning ── */
        .duration-info { font-size: 12px; color: var(--text-2); margin-top: 6px; display: flex; gap: 12px; }
        .duration-error { font-size: 12px; color: var(--red); margin-top: 4px; display: flex; align-items: center; gap: 4px; }

        /* ── Checkbox-like close btn ── */
        .close-btn {
            width: 28px; height: 28px;
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            color: var(--text-2);
            transition: all var(--transition);
            background: transparent;
            border: none;
            font-size: 14px;
        }
        .close-btn:hover { background: var(--surface-2); color: var(--text); }

        /* ── Comment textarea animation ── */
        .comment-area { animation: expandIn 0.1s ease; overflow: hidden; }
        @keyframes expandIn { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 200px; } }

        /* ── File input ── */
        .file-input-wrap { position: relative; }
        .file-input-wrap input[type="file"] { display: none; }
        .file-input-label {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 14px;
            background: var(--surface);
            border: 1.5px dashed var(--border-strong);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 13px;
            color: var(--text-2);
            transition: all var(--transition);
        }
        .file-input-label:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
        .file-input-label.has-file { border-color: var(--green); color: var(--green); background: var(--green-light); border-style: solid; }

        /* ── Scrollbar ── */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-3); }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

const API_BASE_URL = 'https://otp-2-fos4.onrender.com';
const AUTH_REFRESH_URL = `${API_BASE_URL}/api/auth/refresh`;
let refreshPromise = null;
const audioUrlCache = {};

const readJsonSafe = async (r) => { try { return await r.json(); } catch { return null; } };

const authFetch = async (url, opts = {}, retry = true) => {
    const res = await fetch(url, { credentials: 'include', ...opts, headers: { ...(opts.headers || {}) } });
    if (res.status !== 401 || !retry) return res;
    const body = await readJsonSafe(res.clone());
    if (!body || body.code !== 'TOKEN_EXPIRED') return res;
    if (!refreshPromise) {
        refreshPromise = fetch(AUTH_REFRESH_URL, { method: 'POST', credentials: 'include' }).finally(() => { refreshPromise = null; });
    }
    const rr = await refreshPromise;
    if (!rr.ok) return res;
    return authFetch(url, opts, false);
};

const getAudioUrl = async (evalId, userId) => {
    if (audioUrlCache[evalId]) return audioUrlCache[evalId];
    try {
        const r = await authFetch(`${API_BASE_URL}/api/audio/${evalId}`, { headers: { 'X-User-Id': userId } });
        if (!r.ok) return null;
        const d = await r.json();
        if (d?.url) { audioUrlCache[evalId] = d.url; return d.url; }
        return null;
    } catch { return null; }
};

const safeAtob = (s) => decodeURIComponent(Array.prototype.map.call(atob(s), c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));

const escapeHtml = (s) => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');

const parseToHtml = (text) => {
    if (!text) return '';
    const lines = text.split(/\r?\n/);
    let html = '', stack = [];
    const closeLists = (lvl = 0) => { while (stack.length > lvl) { html += stack.pop() === 'ol' ? '</ol>' : '</ul>'; } };
    for (const raw of lines) {
        const line = raw.replace(/\t/g, '    ');
        if (!line.trim()) { closeLists(); html += '<p>&nbsp;</p>'; continue; }
        const om = line.match(/^\s*(\d+(?:\.\d+)*)\.\s*(.*)$/);
        if (om) {
            const lvl = om[1].split('.').length;
            if (stack.length < lvl) { for (let j = stack.length; j < lvl; j++) { html += `<ol style="padding-left:18px;margin-bottom:6px">`; stack.push('ol'); } }
            else if (stack.length > lvl) closeLists(lvl);
            html += `<li>${escapeHtml(om[2].trim())}</li>`; continue;
        }
        const ulm = line.match(/^\s*[-•*]\s+(.*)/);
        if (ulm) {
            if (!stack.length || stack[stack.length-1] !== 'ul') { html += '<ul style="padding-left:18px;margin-bottom:6px">'; stack.push('ul'); }
            html += `<li>${escapeHtml(ulm[1].trim())}</li>`; continue;
        }
        closeLists();
        html += `<p style="margin-bottom:6px">${escapeHtml(line)}</p>`;
    }
    closeLists();
    return html;
};

// ─── Score Toggle Button ───────────────────────────────
const ScoreToggle = ({ label, value, active, onClick }) => (
    <button
        type="button"
        onClick={onClick}
        className={`score-toggle ${active ? `active-${value.toLowerCase()}` : ''}`}
    >{label}</button>
);

// ─── Criterion Card ────────────────────────────────────
const CriterionCard = ({ criterion, index, score, comment, commentVisible, onScoreChange, onCommentChange, onToggleComment, onShowInfo }) => {
    const isNeg = score === 'Error' || score === 'Incorrect' || score === 'Deficiency';
    return (
        <div className={`crit-card ${isNeg ? 'is-error' : 'is-correct'}`}>
            <div className="crit-card-header">
                <div className="crit-card-name" style={criterion.isCritical ? {color:'var(--red)'} : {}}>
                    {criterion.name}
                </div>
                <span className={`crit-weight ${criterion.isCritical ? 'critical' : ''}`}>
                    {criterion.isCritical ? 'Критерий' : `${criterion.weight} pts`}
                </span>
                <button className={`crit-comment-toggle ${commentVisible ? 'active' : ''}`} onClick={onToggleComment} title="Комментарий">
                    <i className="fa-regular fa-comment-dots" />
                </button>
                <button className="crit-info-btn" onClick={onShowInfo} title="Описание критерия">
                    <i className="fa-regular fa-circle-question" />
                </button>
            </div>
            <div className="crit-card-body">
                <div className="score-toggles">
                    <ScoreToggle label="Корректно" value="Correct" active={score === 'Correct'} onClick={() => onScoreChange('Correct')} />
                    <ScoreToggle label="N/A" value="na" active={score === 'N/A'} onClick={() => onScoreChange('N/A')} />
                    {!criterion.isCritical && (
                        <>
                            <ScoreToggle label="Ошибка" value="Incorrect" active={score === 'Incorrect'} onClick={() => onScoreChange('Incorrect')} />
                            {criterion.deficiency && (
                                <ScoreToggle label="Недочёт" value="Deficiency" active={score === 'Deficiency'} onClick={() => onScoreChange('Deficiency')} />
                            )}
                        </>
                    )}
                    {criterion.isCritical && (
                        <ScoreToggle label="Критич. ошибка" value="Error" active={score === 'Error'} onClick={() => onScoreChange('Error')} />
                    )}
                </div>

                {(isNeg || commentVisible) && (
                    <div className="comment-area" style={{marginTop: 8}}>
                        <textarea
                            className="textarea"
                            style={{marginTop: 0, minHeight: 64}}
                            value={comment || ''}
                            onChange={e => onCommentChange(e.target.value)}
                            placeholder={isNeg ? `Укажите причину ошибки в критерии "${criterion.name}"` : `Комментарий (необязательно)`}
                            rows={2}
                        />
                        {isNeg && !comment?.trim() && (
                            <div className="error-text">Комментарий обязателен</div>
                        )}
                    </div>
                )}
            </div>
        </div>
    );
};

// ─── Login Modal ───────────────────────────────────────
const LoginModal = ({ isOpen, onLogin }) => {
    const [login, setLogin] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        try {
            const r = await authFetch(`${API_BASE_URL}/api/login`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({login, password}) });
            const d = await r.json();
            if (d.status === 'success') { setError(''); onLogin(d.user || d); }
            else setError(d.error || 'Неверные данные');
        } catch(e) { setError('Ошибка: ' + e.message); }
        finally { setLoading(false); }
    };

    if (!isOpen) return null;
    return (
        <div className="modal-backdrop">
            <div className="modal" style={{maxWidth: 400}}>
                <div className="modal-header">
                    <div>
                        <h2>Вход в систему</h2>
                        <div className="modal-header-sub">Введите данные учётной записи</div>
                    </div>
                </div>
                <div className="modal-body">
                    {error && <div style={{padding:'8px 12px', background:'var(--red-light)', color:'var(--red)', borderRadius:'var(--radius)', marginBottom:12, fontSize:13}}>{error}</div>}
                    <div className="field">
                        <label className="label">Логин</label>
                        <input className="input" type="text" value={login} onChange={e => setLogin(e.target.value)} placeholder="Введите логин" onKeyDown={e => e.key === 'Enter' && handleSubmit(e)} />
                    </div>
                    <div className="field">
                        <label className="label">Пароль</label>
                        <input className="input" type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder="Введите пароль" onKeyDown={e => e.key === 'Enter' && handleSubmit(e)} />
                    </div>
                </div>
                <div className="modal-footer">
                    <button className="btn btn-primary btn-lg" onClick={handleSubmit} disabled={loading}>
                        {loading ? <><span className="spinner" /> Вход...</> : 'Войти'}
                    </button>
                </div>
            </div>
        </div>
    );
};

// ─── SV Request Button ─────────────────────────────────
const SvRequestButton = ({ call, userId, userRole, fetchEvaluations, onReevaluate }) => {
    const [showModal, setShowModal] = useState(false);
    const [comment, setComment] = useState('');
    const [loading, setLoading] = useState(false);
    const isSv = String(userRole) === 'sv';
    if (!isSv) return null;

    const submit = async () => {
        setLoading(true);
        try {
            const r = await authFetch(`${API_BASE_URL}/api/call_evaluation/sv_request`, {
                method: 'POST', headers: {'Content-Type':'application/json', 'X-User-Id': userId},
                body: JSON.stringify({ call_id: call.id, comment })
            });
            const d = await r.json();
            if (!r.ok) throw new Error(d.error);
            await fetchEvaluations?.();
            setShowModal(false); setComment('');
            alert('Заявка отправлена');
        } catch(e) { alert('Ошибка: ' + e.message); }
        finally { setLoading(false); }
    };

    if (!call.sv_request) return (
        <>
            <button className="btn btn-amber btn-sm" onClick={e => { e.stopPropagation(); setShowModal(true); }}>Запрос</button>
            {showModal && (
                <div className="modal-backdrop" onClick={e => { e.stopPropagation(); setShowModal(false); }}>
                    <div className="modal request-modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <div><h2>Запрос на переоценку</h2><div className="modal-header-sub">Call ID: {call.id}</div></div>
                            <button className="close-btn" onClick={() => setShowModal(false)}><i className="fas fa-times"/></button>
                        </div>
                        <div className="modal-body">
                            <div className="field">
                                <label className="label">Комментарий (необязательно)</label>
                                <textarea className="textarea" value={comment} onChange={e => setComment(e.target.value)} placeholder="Опишите причину запроса..." />
                            </div>
                        </div>
                        <div className="modal-footer">
                            <button className="btn btn-secondary" onClick={() => setShowModal(false)}>Отмена</button>
                            <button className="btn btn-amber" onClick={submit} disabled={loading}>{loading ? <><span className="spinner" style={{borderTopColor:'var(--amber)'}} /> Отправка...</> : 'Отправить'}</button>
                        </div>
                    </div>
                </div>
            )}
        </>
    );

    if (call.sv_request && !call.sv_request_approved) return (
        <div className="tooltip-wrap">
            <span style={{fontSize:13, color:'var(--amber)', display:'flex', alignItems:'center', gap:4}}>
                <i className="fas fa-clock" style={{fontSize:11}} /> Ожидает
            </span>
            <div className="tooltip-box">{[call.sv_request_comment && `Комментарий: ${call.sv_request_comment}`, call.sv_request_by_name && `От: ${call.sv_request_by_name}`].filter(Boolean).join('\n') || 'Запрос на рассмотрении'}</div>
        </div>
    );

    if (call.sv_request_approved) return (
        <div style={{display:'flex', alignItems:'center', gap:6}}>
            <div className="tooltip-wrap">
                <i className="fas fa-info-circle" style={{color:'var(--green)', cursor:'pointer'}} />
                <div className="tooltip-box">{[call.sv_request_comment && `Комм.: ${call.sv_request_comment}`, call.sv_request_by_name && `Запросил: ${call.sv_request_by_name}`, call.sv_request_approved_by_name && `Одобрил: ${call.sv_request_approved_by_name}`].filter(Boolean).join('\n') || 'Запрос одобрен'}</div>
            </div>
            <button className="btn btn-primary btn-sm" onClick={e => { e.stopPropagation(); onReevaluate(); }}>Переоценить</button>
        </div>
    );
    return null;
};

// ─── Date Range Picker ─────────────────────────────────
const DateRangePicker = ({ minDate, maxDate, setFromDate, setToDate }) => {
    const ref = useRef(null);
    const [label, setLabel] = useState('');

    useEffect(() => {
        if (!ref.current) return;
        flatpickr(ref.current, {
            mode: 'range', dateFormat: 'Y-m-d', minDate, maxDate,
            onChange(dates) {
                if (dates.length === 2) {
                    const end = new Date(dates[1]);
                    end.setDate(end.getDate() + 1); end.setMilliseconds(-1);
                    setFromDate(dates[0].toISOString());
                    setToDate(end.toISOString());
                    setLabel(`${dates[0].toISOString().slice(0,10)} — ${dates[1].toISOString().slice(0,10)}`);
                } else { setFromDate(null); setToDate(null); setLabel(''); }
            }
        });
    }, [minDate, maxDate]);

    return (
        <div className="filter-group">
            <label className="label">Период</label>
            <input ref={ref} className="input" type="text" placeholder="Выбрать период" readOnly style={{minWidth:200, cursor:'pointer'}} />
        </div>
    );
};

// ─── Evaluation Modal ──────────────────────────────────
const EvaluationModal = ({ isOpen, onClose, onSubmit, directions, operator, selectedMonth, userId, userName, existingEvaluation }) => {
    const [callFile, setCallFile] = useState(null);
    const [audioUrl, setAudioUrl] = useState(null);
    const [audioError, setAudioError] = useState(null);
    const [scores, setScores] = useState([]);
    const [comments, setComments] = useState([]);
    const [commentVisible, setCommentVisible] = useState([]);
    const [phoneNumber, setPhoneNumber] = useState('');
    const [phoneError, setPhoneError] = useState('');
    const [appealDate, setAppealDate] = useState('');
    const [assignedMonth, setAssignedMonth] = useState(selectedMonth);
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [selectedDirId, setSelectedDirId] = useState(null);
    const [infoIndex, setInfoIndex] = useState(null);
    const [expectedDuration, setExpectedDuration] = useState(null);
    const [actualDuration, setActualDuration] = useState(null);
    const [durationMismatch, setDurationMismatch] = useState(false);
    const isLocked = !!(existingEvaluation?.isReevaluation || existingEvaluation?.is_imported);

    const currentDir = directions?.find(d => d.id === selectedDirId) || directions?.[0] || null;
    const criteria = currentDir?.criteria || [];
    const monthsRu = ['янв.','февр.','мар.','апр.','май','июн.','июл.','авг.','сент.','окт.','ноя.','дек.'];

    const MIN_TOL = 3, PCT_TOL = 0.15;
    const fmtSec = (s) => {
        if (!s) return '—';
        const t = Math.round(s), h = Math.floor(t/3600), m = Math.floor((t%3600)/60), sec = t%60;
        return h > 0 ? `${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}` : `${m}:${String(sec).padStart(2,'0')}`;
    };

    useEffect(() => {
        if (!isOpen || !directions?.length) return;
        const initId = existingEvaluation
            ? (existingEvaluation.directionId ?? existingEvaluation._rawEvaluation?.direction_id ?? directions.find(d=>d.name===existingEvaluation.selectedDirection)?.id ?? operator?.direction_id ?? directions[0]?.id)
            : (operator?.direction_id ?? directions[0]?.id);
        setSelectedDirId(initId);
        const initDir = directions.find(d=>d.id===initId) || directions[0];

        if (existingEvaluation) {
            if (existingEvaluation.is_imported) {
                const ed = existingEvaluation.duration || existingEvaluation._rawEvaluation?.duration || null;
                setExpectedDuration(ed ? parseFloat(ed) : null);
                setActualDuration(null); setDurationMismatch(false);
                setPhoneNumber(existingEvaluation.phoneNumber || '');
                const date = new Date(existingEvaluation.appeal_date);
                setAppealDate(initDir?.hasFileUpload
                    ? `${date.getDate().toString().padStart(2,'0')}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getFullYear()} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}:${date.getSeconds().toString().padStart(2,'0')}`
                    : `${date.getDate()} ${monthsRu[date.getMonth()]} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`);
                setScores(initDir?.criteria?.map(()=>'Correct') || []);
                setComments(initDir?.criteria?.map(()=>'') || []);
                setCommentVisible(initDir?.criteria?.map(()=>false) || []);
                setAssignedMonth(selectedMonth); setAudioUrl(null); setCallFile(null); setPhoneError('');
            } else {
                setScores(existingEvaluation.scores || []);
                setComments(existingEvaluation.criterionComments || []);
                setCommentVisible((existingEvaluation.criterionComments||[]).map(c=>!!(c&&c.trim())));
                setPhoneNumber(existingEvaluation.phoneNumber || '');
                setAssignedMonth(existingEvaluation.assignedMonth || selectedMonth);
                setAudioUrl(existingEvaluation.audioUrl || null);
                setActualDuration(null); setDurationMismatch(false);
                if (existingEvaluation.appeal_date) {
                    const date = new Date(existingEvaluation.appeal_date);
                    setAppealDate(initDir?.hasFileUpload
                        ? `${date.getDate().toString().padStart(2,'0')}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getFullYear()} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}:${date.getSeconds().toString().padStart(2,'0')}`
                        : `${date.getDate()} ${monthsRu[date.getMonth()]} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`);
                } else setAppealDate('');
                setPhoneError('');
            }
        } else {
            setExpectedDuration(null); setActualDuration(null); setDurationMismatch(false);
            setScores(initDir?.criteria?.map(()=>'Correct') || []);
            setComments(initDir?.criteria?.map(()=>'') || []);
            setCommentVisible(initDir?.criteria?.map(()=>false) || []);
            setCallFile(null); setAudioUrl(null); setPhoneNumber(''); setAppealDate(''); setPhoneError('');
            setAssignedMonth(selectedMonth);
        }
    }, [isOpen, existingEvaluation, directions, selectedMonth, operator?.direction_id]);

    useEffect(() => {
        if (!existingEvaluation?.id || !currentDir?.hasFileUpload || !userId || existingEvaluation?.is_imported) return;
        getAudioUrl(existingEvaluation.id, userId).then(url => { if (url) setAudioUrl(url); else setAudioError('Не удалось загрузить аудио'); });
    }, [existingEvaluation, userId, currentDir?.hasFileUpload]);

    const handleFile = (e) => {
        const file = e.target.files[0];
        setCallFile(file);
        const url = file ? URL.createObjectURL(file) : null;
        setAudioUrl(url); setAudioError(null); setActualDuration(null); setDurationMismatch(false);
        if (file && url) {
            const audio = new Audio(url);
            audio.addEventListener('loadedmetadata', () => {
                const dur = audio.duration;
                setActualDuration(dur);
                if (expectedDuration) {
                    const allowed = Math.max(MIN_TOL, expectedDuration * PCT_TOL);
                    if (Math.abs(dur - expectedDuration) > allowed) { setDurationMismatch(true); setAudioError(`Длительность файла (${fmtSec(dur)}) ≠ ожидаемой (${fmtSec(expectedDuration)})`); }
                    else setDurationMismatch(false);
                }
            });
            audio.addEventListener('error', () => setAudioError('Не удалось прочитать аудио файл'));
            audio.load();
        }
    };

    const fmtDate = (input) => {
        const hf = currentDir?.hasFileUpload;
        if (hf) {
            let d = input.replace(/\D/g,'').slice(0,14);
            let f = '';
            if (d.length > 0) f += d.slice(0,2);
            if (d.length > 2) f += '-' + d.slice(2,4);
            if (d.length > 4) f += '-' + d.slice(4,8);
            if (d.length > 8) f += ' ' + d.slice(8,10);
            if (d.length > 10) f += ':' + d.slice(10,12);
            if (d.length > 12) f += ':' + d.slice(12,14);
            return f;
        } else {
            const hasMonth = monthsRu.some(m => input.toLowerCase().includes(m.toLowerCase()));
            if (hasMonth) return input;
            let d = input.replace(/\D/g,'');
            if (d.length <= 2) return d;
            if (d.length <= 4) { const m = parseInt(d.slice(2,4)); return m>=1&&m<=12 ? d.slice(0,2)+' '+monthsRu[m-1] : d.slice(0,2); }
            if (d.length <= 6) { const m = parseInt(d.slice(2,4)); return m>=1&&m<=12 ? d.slice(0,2)+' '+monthsRu[m-1]+' '+d.slice(4,6) : d.slice(0,2)+' '+d.slice(4,6); }
            const m = parseInt(d.slice(2,4));
            return m>=1&&m<=12 ? d.slice(0,2)+' '+monthsRu[m-1]+' '+d.slice(4,6)+':'+d.slice(6,8) : d.slice(0,2)+' '+d.slice(4,6)+':'+d.slice(6,8);
        }
    };

    const getAppealDateISO = () => {
        if (!appealDate) return null;
        const hf = currentDir?.hasFileUpload;
        if (hf) {
            let d = appealDate.replace(/\D/g,'');
            const isRe = existingEvaluation?.id != null;
            if (isRe) { if (d.length < 12) return null; const s = d.length>=14 ? d.slice(12,14) : '00'; return `${d.slice(4,8)}-${d.slice(2,4)}-${d.slice(0,2)}T${d.slice(8,10)}:${d.slice(10,12)}:${s}`; }
            if (d.length !== 14) return null;
            return `${d.slice(4,8)}-${d.slice(2,4)}-${d.slice(0,2)}T${d.slice(8,10)}:${d.slice(10,12)}:${d.slice(12,14)}`;
        } else {
            const m = appealDate.trim().match(/^(\d{1,2})\s+([а-яё]+\.?)\s+(\d{1,2}):(\d{2})$/i);
            if (!m) return null;
            const mi = monthsRu.findIndex(x => x.replace(/\./,'').toLowerCase() === m[2].toLowerCase().replace(/\./,''));
            if (mi === -1) return null;
            return `${new Date().getFullYear()}-${String(mi+1).padStart(2,'0')}-${m[1].padStart(2,'0')}T${m[3].padStart(2,'0')}:${m[4]}:00`;
        }
    };

    const handleDirChange = (id) => {
        setSelectedDirId(id);
        const d = directions.find(x=>x.id===id) || directions[0];
        if (d?.criteria) { setScores(d.criteria.map(()=>'Correct')); setComments(d.criteria.map(()=>'')); setCommentVisible(d.criteria.map(()=>false)); }
    };

    const hasCriticalError = criteria.some((c,i) => c.isCritical && scores[i]==='Error');
    const totalScore = hasCriticalError ? 0 : criteria.reduce((sum, c, i) => {
        if (c.isCritical) return sum;
        if (scores[i]==='Correct'||scores[i]==='N/A') return sum + c.weight;
        if (scores[i]==='Deficiency'&&c.deficiency) return sum + c.deficiency.weight;
        return sum;
    }, 0);

    const isSubmitDisabled = !currentDir || !criteria.length ||
        (currentDir?.hasFileUpload && !callFile && !audioUrl) ||
        scores.some((s,i) => (s==='Error'||s==='Incorrect') && !comments[i]?.trim()) ||
        durationMismatch;

    const handleSubmit = async (draft = false) => {
        setIsSubmitting(true);
        const fd = new FormData();
        fd.append('evaluator', userName);
        fd.append('operator', operator.name);
        fd.append('phone_number', phoneNumber);
        fd.append('score', totalScore);
        fd.append('comment', criteria.map((c,i)=>comments[i]?`${c.name}: ${comments[i]}`:'').filter(Boolean).join('; '));
        fd.append('month', assignedMonth);
        fd.append('is_draft', draft);
        fd.append('scores', JSON.stringify(scores));
        fd.append('criterion_comments', JSON.stringify(comments));
        fd.append('direction', currentDir?.id ?? operator?.direction_id);
        const ad = getAppealDateISO();
        if (ad) fd.append('appeal_date', ad);
        if (existingEvaluation?.isReevaluation) { fd.append('previous_version_id', existingEvaluation.id); fd.append('is_correction', true); }
        if (callFile) fd.append('audio_file', callFile);
        try {
            const r = await authFetch(`${API_BASE_URL}/api/call_evaluation`, { method:'POST', headers:{'X-User-Id':userId}, body: fd });
            const res = await r.json();
            if (res.status === 'success') {
                onSubmit({ id: res.evaluation_id, evaluator: userName, operator: operator.name, phoneNumber, totalScore: totalScore.toFixed(2), comment: fd.get('comment'), selectedDirection: currentDir?.name, directionId: currentDir?.id, is_imported: false, directions: [{name: currentDir?.name, hasFileUpload: currentDir?.hasFileUpload, criteria}], scores, criterionComments: comments, audioUrl: currentDir?.hasFileUpload ? audioUrl : null, isDraft: draft, assignedMonth, isCorrection: existingEvaluation?.isReevaluation || false, appeal_date: ad });
                onClose();
            } else alert('Ошибка: ' + res.error);
        } catch(e) { alert('Ошибка отправки: ' + e.message); }
        finally { setIsSubmitting(false); }
    };

    const handleDeleteDraft = async () => {
        if (!existingEvaluation?.isDraft) return;
        try {
            const r = await authFetch(`${API_BASE_URL}/api/call_evaluation/${existingEvaluation.id}`, { method:'DELETE', headers:{'X-User-Id':userId} });
            const res = await r.json();
            if (res.status === 'success') { onSubmit(null); onClose(); }
            else alert('Ошибка удаления: ' + res.error);
        } catch(e) { alert('Ошибка: ' + e.message); }
    };

    if (!isOpen) return null;
    const title = existingEvaluation?.isReevaluation ? 'Переоценка' : existingEvaluation?.isDraft ? 'Редактирование черновика' : 'Новая оценка';

    return (
        <div className="modal-backdrop">
            <div className="modal modal-wide" onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                    <div>
                        <h2>{title}</h2>
                        <div className="modal-header-sub">Оператор: {operator?.name}</div>
                    </div>
                    <button className="close-btn" onClick={onClose}><i className="fas fa-times" /></button>
                </div>
                <div className="modal-body">
                    {/* Direction selector */}
                    {directions?.length > 1 && (
                        <div style={{marginBottom: 16}}>
                            <label className="label">Направление</label>
                            <div className="dir-tabs">
                                {directions.map(d => (
                                    <button key={d.id} className={`dir-tab ${selectedDirId === d.id ? 'active' : ''}`} onClick={() => handleDirChange(d.id)}>{d.name}</button>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Audio upload */}
                    {currentDir?.hasFileUpload && (
                        <>
                            <div className="section-divider">Аудиозапись</div>
                            {!existingEvaluation?.isReevaluation && (
                                <div className="file-input-wrap" style={{marginBottom: 10}}>
                                    <label htmlFor="audioFile" className={`file-input-label ${callFile ? 'has-file' : ''}`}>
                                        <i className={`fas ${callFile ? 'fa-check-circle' : 'fa-cloud-upload-alt'}`} />
                                        {callFile ? callFile.name : 'Нажмите для загрузки аудиофайла'}
                                    </label>
                                    <input id="audioFile" type="file" accept="audio/*" onChange={handleFile} />
                                </div>
                            )}
                            {audioUrl && (
                                <div className="audio-wrap">
                                    <div className="audio-label">Прослушать запись</div>
                                    <audio controls style={{width:'100%'}}><source src={audioUrl} type="audio/mpeg" /></audio>
                                </div>
                            )}
                            {(expectedDuration || actualDuration) && (
                                <div className="duration-info">
                                    <span>Ожидаемая: <strong>{fmtSec(expectedDuration)}</strong></span>
                                    <span>Фактическая: <strong>{fmtSec(actualDuration) || '—'}</strong></span>
                                </div>
                            )}
                            {durationMismatch && <div className="duration-error"><i className="fas fa-exclamation-circle" />{audioError}</div>}
                            {audioError && !durationMismatch && <div className="error-text">{audioError}</div>}
                        </>
                    )}

                    {/* Phone + Date */}
                    <div className="section-divider">Данные обращения</div>
                    <div className="grid-2">
                        <div className="field">
                            <label className="label">Номер телефона</label>
                            <input
                                className="input"
                                type="text"
                                value={phoneNumber}
                                onChange={e => { const v = e.target.value.replace(/[^0-9+]/g,''); setPhoneNumber(v); setPhoneError(v.length < 5 ? 'Слишком короткий номер' : ''); }}
                                placeholder="+7 000 000 0000"
                                readOnly={isLocked}
                            />
                            {phoneError && <div className="error-text">{phoneError}</div>}
                        </div>
                        <div className="field">
                            <label className="label">Дата обращения</label>
                            <input
                                className="input"
                                type="text"
                                value={appealDate}
                                onChange={e => setAppealDate(fmtDate(e.target.value))}
                                placeholder={currentDir?.hasFileUpload ? 'DD-MM-YYYY HH:MM:SS' : 'DD месяц HH:MM'}
                                readOnly={isLocked}
                                style={{fontFamily: 'var(--font-mono)'}}
                            />
                        </div>
                    </div>

                    {/* Criteria */}
                    <div className="section-divider">Критерии оценивания</div>
                    {!criteria.length ? (
                        <div style={{padding:'12px',color:'var(--red)',fontSize:13}}>У направления нет критериев.</div>
                    ) : (
                        <div style={{maxHeight: 380, overflowY: 'auto', paddingRight: 4}}>
                            {criteria.map((criterion, i) => (
                                <CriterionCard
                                    key={i}
                                    criterion={criterion}
                                    index={i}
                                    score={scores[i] || 'Correct'}
                                    comment={comments[i]}
                                    commentVisible={commentVisible[i]}
                                    onScoreChange={val => { const s=[...scores]; s[i]=val; setScores(s); }}
                                    onCommentChange={val => { const c=[...comments]; c[i]=val; setComments(c); }}
                                    onToggleComment={() => { const v=[...commentVisible]; v[i]=!v[i]; setCommentVisible(v); }}
                                    onShowInfo={() => setInfoIndex(infoIndex===i ? null : i)}
                                />
                            ))}
                        </div>
                    )}

                    {/* Score summary */}
                    <div className="score-summary" style={{marginTop:12, borderRadius:'var(--radius)', border:'1px solid var(--border)'}}>
                        <span style={{fontSize:13, color:'var(--text-2)'}}>Итоговый балл</span>
                        <span className="score-summary-val" style={{color: hasCriticalError ? 'var(--red)' : totalScore >= 70 ? 'var(--green)' : totalScore >= 50 ? 'var(--amber)' : 'var(--red)'}}>
                            {hasCriticalError ? '0' : totalScore} / 100
                        </span>
                    </div>
                </div>

                <div className="modal-footer">
                    {existingEvaluation?.isDraft && (
                        <button className="btn btn-danger" onClick={handleDeleteDraft} style={{marginRight:'auto'}}>
                            <i className="fas fa-trash" /> Удалить черновик
                        </button>
                    )}
                    <button className="btn btn-secondary" onClick={onClose}>Отмена</button>
                    <button className="btn btn-secondary" onClick={() => handleSubmit(true)} disabled={isSubmitting}>Черновик</button>
                    <button className="btn btn-primary" onClick={() => handleSubmit(false)} disabled={isSubmitDisabled || isSubmitting}>
                        {isSubmitting ? <><span className="spinner" /> Отправка...</> : <><i className="fas fa-check" /> Отправить</>}
                    </button>
                </div>
            </div>

            {/* Info side panel */}
            {infoIndex !== null && criteria[infoIndex] && (
                <div className="info-panel" onClick={e => e.stopPropagation()}>
                    <div className="info-panel-header">
                        <span className="info-panel-title">{criteria[infoIndex].name}</span>
                        <button className="close-btn" onClick={() => setInfoIndex(null)}><i className="fas fa-times" /></button>
                    </div>
                    <div className="info-panel-body" dangerouslySetInnerHTML={{__html: parseToHtml(String(criteria[infoIndex].value || 'Описание отсутствует'))}} />
                </div>
            )}
        </div>
    );
};

// ─── Main App ──────────────────────────────────────────
const App = () => {
    const [userName, setUserName] = useState(null);
    const [userId, setUserId] = useState(null);
    const [userRole, setUserRole] = useState(null);
    const [authChecked, setAuthChecked] = useState(false);
    const [showLoginModal, setShowLoginModal] = useState(false);
    const [calls, setCalls] = useState([]);
    const [directions, setDirections] = useState([]);
    const [operators, setOperators] = useState([]);
    const [supervisors, setSupervisors] = useState([]);
    const [selectedOperator, setSelectedOperator] = useState(null);
    const [selectedSupervisor, setSelectedSupervisor] = useState(null);
    const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0,7));
    const [expandedId, setExpandedId] = useState(null);
    const [editingEval, setEditingEval] = useState(null);
    const [showEvalModal, setShowEvalModal] = useState(false);
    const [isLoading, setIsLoading] = useState(false);
    const [loadingCallId, setLoadingCallId] = useState(null);
    const [operatorFromToken, setOperatorFromToken] = useState(null);
    const [fromDate, setFromDate] = useState(null);
    const [toDate, setToDate] = useState(null);
    const [viewMode, setViewMode] = useState('normal');
    const [showVersionsModal, setShowVersionsModal] = useState(false);
    const [versionHistory, setVersionHistory] = useState([]);
    const MAX_EVALS = 20;

    const fmtDate = (ds) => {
        if (!ds) return '—';
        try {
            const d = new Date(String(ds).replace(' ','T'));
            if (isNaN(d)) return ds;
            return new Intl.DateTimeFormat('ru-RU', {day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}).format(d).replace(/\./g,'').replace(',','');
        } catch { return ds; }
    };

    const months = Array.from({length:12},(_,i) => {
        const d = new Date(new Date().getFullYear(), new Date().getMonth()-i, 1);
        return { value: `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`, label: d.toLocaleString('ru',{month:'long',year:'numeric'}) };
    });

    // Auth
    useEffect(() => {
        authFetch(`${API_BASE_URL}/api/auth/me`).then(async r => {
            const d = await readJsonSafe(r);
            const u = d?.user || d;
            if (r.ok && d?.status==='success' && u?.id) { setUserId(u.id); setUserRole(u.role||null); setUserName(u.name||null); }
            else setShowLoginModal(true);
        }).catch(() => setShowLoginModal(true)).finally(() => setAuthChecked(true));
    }, []);

    // Supervisors
    useEffect(() => {
        if (userRole !== 'admin' || !userId) return;
        authFetch(`${API_BASE_URL}/api/admin/sv_list`, { headers:{'X-User-Id':userId} })
            .then(r=>r.json()).then(d=>{ if(d.status==='success') setSupervisors(d.sv_list||[]); }).catch(console.error);
    }, [userRole, userId]);

    // Token
    useEffect(() => {
        const p = new URLSearchParams(window.location.search);
        const token = p.get('token');
        if (!token) return;
        try {
            const td = JSON.parse(safeAtob(decodeURIComponent(token)));
            if (!td.timestamp || Date.now()-td.timestamp < 300000) {
                setOperatorFromToken({id:td.operatorId, name:td.operatorName});
                if (td.month) setSelectedMonth(td.month);
                if (td.supervisorId) setSelectedSupervisor(td.supervisorId);
            }
        } catch(e) { console.error(e); }
        finally { window.history.replaceState({}, '', window.location.pathname); }
    }, []);

    useEffect(() => {
        if (operatorFromToken && operators.length > 0) {
            setSelectedOperator(operators.find(op=>op.id===operatorFromToken.id) || null);
            setOperatorFromToken(null);
        }
    }, [operators, operatorFromToken]);

    // Directions + Operators
    useEffect(() => {
        if (!userId) return;
        setIsLoading(true);
        const fetchDirs = authFetch(`${API_BASE_URL}/api/admin/directions`, {headers:{'X-User-Id':userId}})
            .then(r=>r.json()).then(d=>{ if(d.status==='success') setDirections(d.directions); }).catch(console.error);
        const fetchOps = authFetch(`${API_BASE_URL}/api/sv/data?id=${userRole==='admin'&&selectedSupervisor ? selectedSupervisor : userId}`, {headers:{'X-User-Id':userId}})
            .then(r=>r.json()).then(d=>{ if(d.status==='success') setOperators(d.operators); }).catch(console.error);
        Promise.all([fetchDirs,fetchOps]).finally(()=>setIsLoading(false));
    }, [userId, userRole, selectedSupervisor]);

    // Evaluations fetch
    const fetchEvaluations = useCallback(async () => {
        if (!selectedOperator || !userId) { setCalls([]); return; }
        setIsLoading(true);
        try {
            const r = await authFetch(`${API_BASE_URL}/api/call_evaluations?operator_id=${selectedOperator.id}`, {headers:{'X-User-Id':userId}});
            const d = await r.json();
            if (d.status === 'success') {
                setCalls(d.evaluations.map(ev => ({
                    id: ev.id,
                    fileName: `Call ${ev.phone_number}`,
                    totalScore: ev.score != null ? parseFloat(ev.score).toFixed(2) : null,
                    date: ev.evaluation_date ? ev.evaluation_date.split('T')[0] : '',
                    phoneNumber: ev.phone_number,
                    combinedComment: ev.comment,
                    appeal_date: ev.appeal_date || '-',
                    selectedDirection: ev.direction?.name || selectedOperator?.direction || '-',
                    directionId: ev.direction?.id ?? null,
                    directions: [{name: ev.direction?.name||'-', hasFileUpload: ev.direction?.hasFileUpload??true, criteria: ev.direction?.criteria||[]}],
                    scores: ev.scores || [],
                    criterionComments: ev.criterion_comments || [],
                    audioUrl: null,
                    isDraft: ev.is_draft,
                    assignedMonth: ev.month,
                    isCorrection: ev.is_correction || false,
                    is_imported: ev.is_imported || false,
                    sv_request: !!ev.sv_request,
                    sv_request_comment: ev.sv_request_comment || null,
                    sv_request_by: ev.sv_request_by || null,
                    sv_request_by_name: ev.sv_request_by_name || null,
                    sv_request_at: ev.sv_request_at || null,
                    sv_request_approved: !!ev.sv_request_approved,
                    sv_request_approved_by: ev.sv_request_approved_by || null,
                    sv_request_approved_by_name: ev.sv_request_approved_by_name || null,
                    sv_request_approved_at: ev.sv_request_approved_at || null,
                    _rawEvaluation: ev
                })));
            }
        } catch(e) { console.error(e); }
        finally { setIsLoading(false); }
    }, [selectedOperator, userId]);

    useEffect(() => { fetchEvaluations(); }, [fetchEvaluations]);
    useEffect(() => { setFromDate(null); setToDate(null); }, [selectedMonth]);

    const handleLogin = (u) => {
        if (!u?.id) { setShowLoginModal(true); return false; }
        setUserId(u.id); setUserRole(u.role||null); setUserName(u.name||null);
        setShowLoginModal(false); return true;
    };

    const handleLogout = () => {
        setUserId(null); setUserRole(null); setUserName(null);
        setOperators([]); setSelectedOperator(null); setDirections([]); setCalls([]);
        setSupervisors([]); setSelectedSupervisor(null); setExpandedId(null);
        setShowEvalModal(false); setEditingEval(null); setShowLoginModal(true);
    };

    const handleEvaluateCall = (data) => {
        setCalls(prev => {
            if (!data) return prev.filter(c => c.id !== editingEval?.id);
            const newCall = {
                id: data.id, fileName: `Call ${data.phoneNumber}`, scores: data.scores, criterionComments: data.criterionComments,
                combinedComment: data.comment, totalScore: data.totalScore, date: new Date().toISOString().slice(0,10),
                audioUrl: data.audioUrl, isDraft: data.isDraft, selectedDirection: data.selectedDirection,
                directionId: data.directionId ?? selectedOperator?.direction_id, directions: data.directions,
                phoneNumber: data.phoneNumber, assignedMonth: data.assignedMonth, isCorrection: data.isCorrection,
                appeal_date: data.appeal_date, is_imported: false,
                sv_request: false, sv_request_approved: false, _rawEvaluation: {}
            };
            let updated = data.isCorrection
                ? prev.filter(c => c.id !== data.id && c.id !== editingEval?.id)
                : prev.filter(c => c.id !== newCall.id);
            return [...updated, newCall];
        });
        if (data?.isCorrection && data?.id) { delete audioUrlCache[data.id]; if (editingEval?.id) delete audioUrlCache[editingEval.id]; }
        setEditingEval(null);
        if (!data?.isDraft) fetchEvaluations();
    };

    const handleSelectCall = async (callId) => {
        const call = calls.find(c => c.id === callId);
        if (!call) return;
        if (call.isDraft) { setEditingEval(call); setShowEvalModal(true); return; }
        if (expandedId !== callId) {
            setLoadingCallId(callId);
            if (!call.audioUrl && call.directions?.[0]?.hasFileUpload) {
                const url = await getAudioUrl(call.id, userId);
                if (url) setCalls(prev => prev.map(c => c.id===callId ? {...c, audioUrl:url} : c));
            }
            setExpandedId(callId);
            setLoadingCallId(null);
        } else setExpandedId(null);
    };

    const deleteImportedCall = async (id) => {
        if (!confirm('Удалить импортированный звонок?')) return;
        try {
            const r = await authFetch(`${API_BASE_URL}/api/call_evaluations/${id}`, { method:'DELETE', headers:{'Content-Type':'application/json','X-User-Id':userId} });
            const d = await r.json();
            if (!r.ok) throw new Error(d.error);
            setCalls(prev => prev.filter(c => c.id !== id));
        } catch(e) { alert('Ошибка: ' + e.message); }
    };

    const callsByMonth = calls.filter(c => c.assignedMonth === selectedMonth);
    let displayedCalls = callsByMonth;
    if (viewMode === 'normal') displayedCalls = displayedCalls.filter(c => (!fromDate||c.date>=fromDate) && (!toDate||c.date<=toDate));
    else displayedCalls = displayedCalls.filter(c => c.date.slice(0,7) !== selectedMonth);

    const hasExtra = callsByMonth.filter(c => c.date.slice(0,7) !== selectedMonth).length > 0;
    const evalCount = displayedCalls.filter(c => !c.isDraft && !c.is_imported).length;
    const avgScore = evalCount > 0 ? displayedCalls.filter(c=>!c.isDraft&&!c.is_imported).reduce((s,c)=>s+parseFloat(c.totalScore),0)/evalCount : 0;
    const isMaxReached = callsByMonth.filter(c=>!c.isDraft&&!c.is_imported).length >= MAX_EVALS;

    const getScoreClass = (s) => {
        const v = parseFloat(s);
        if (isNaN(v)) return '';
        if (v >= 80) return 'score-high';
        if (v >= 60) return 'score-mid';
        return 'score-low';
    };

    if (!authChecked) return (
        <div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center',background:'var(--bg)'}}>
            <div style={{fontSize:13,color:'var(--text-2)'}}>Проверка сессии...</div>
        </div>
    );

    return (
        <div className="app">
            {/* Header */}
            <header className="header">
                <div className="header-logo">
                    <div className="header-logo-dot" />
                    <h1>Оценки операторов</h1>
                </div>
                <div className="header-right">
                    {userName && <span className="header-user">{userName}</span>}
                    <button className="btn btn-danger btn-sm" onClick={handleLogout}>
                        <i className="fas fa-sign-out-alt" /> Выйти
                    </button>
                </div>
            </header>

            {/* Main panel */}
            <div className="main-panel">
                {/* Panel header with filters */}
                <div className="panel-header">
                    <span className="panel-title">Журнал оценок</span>
                    <div className="filters">
                        {userRole === 'admin' && (
                            <div className="filter-group">
                                <label className="label">Супервайзер</label>
                                <select className="select" value={selectedSupervisor||''} onChange={e => { setSelectedSupervisor(parseInt(e.target.value)||null); setSelectedOperator(null); setOperators([]); setCalls([]); }}>
                                    <option value="">Выбрать</option>
                                    {[...supervisors].sort((a,b)=>a.name.localeCompare(b.name,'ru')).map(sv => (
                                        <option key={sv.id} value={sv.id}>{sv.name}{sv.status==='fired'?' (уволен)':''}</option>
                                    ))}
                                </select>
                            </div>
                        )}
                        <div className="filter-group">
                            <label className="label">Оператор</label>
                            <select className="select" value={selectedOperator?.id||''} onChange={e => { const op=operators.find(o=>o.id===parseInt(e.target.value))||null; setSelectedOperator(op); setCalls([]); setExpandedId(null); }}>
                                <option value="">Выбрать</option>
                                {[...operators.filter(o=>o.status!=='fired').sort((a,b)=>a.name.localeCompare(b.name,'ru'))].map(op => (
                                    <option key={op.id} value={op.id}>{op.name}</option>
                                ))}
                                {operators.filter(o=>o.status==='fired').sort((a,b)=>a.name.localeCompare(b.name,'ru')).map(op => (
                                    <option key={op.id} value={op.id}>{op.name} (уволен)</option>
                                ))}
                            </select>
                        </div>
                        <div className="filter-group">
                            <label className="label">Месяц</label>
                            <select className="select" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)}>
                                {months.map(m => <option key={m.value} value={m.value}>{m.label}</option>)}
                            </select>
                        </div>
                        {userRole === 'admin' && (() => {
                            const lastDay = new Date(parseInt(selectedMonth.slice(0,4)), parseInt(selectedMonth.slice(5,7)), 0).getDate();
                            return <DateRangePicker minDate={`${selectedMonth}-01`} maxDate={`${selectedMonth}-${String(lastDay).padStart(2,'0')}`} setFromDate={setFromDate} setToDate={setToDate} />;
                        })()}
                    </div>
                </div>

                {/* Stats bar */}
                {selectedOperator && (
                    <div className="stats-bar">
                        <div className="stat-item">
                            <div className="stat-icon blue"><i className="fas fa-headset" /></div>
                            <div>
                                <div className="stat-value">{evalCount} <span style={{fontSize:12,color:'var(--text-2)',fontFamily:'var(--font)',fontWeight:400}}>/ {MAX_EVALS}</span></div>
                                <div className="stat-label">Оценок в месяце</div>
                            </div>
                        </div>
                        <div className="stat-item">
                            <div className="stat-icon green"><i className="fas fa-chart-line" /></div>
                            <div>
                                <div className="stat-value" style={{color: avgScore >= 80 ? 'var(--green)' : avgScore >= 60 ? 'var(--amber)' : avgScore > 0 ? 'var(--red)' : 'var(--text)'}}>
                                    {evalCount > 0 ? avgScore.toFixed(1) : '—'}
                                </div>
                                <div className="stat-label">Средний балл</div>
                            </div>
                        </div>
                        <div className="stat-item" style={{flex: 2}}>
                            <div style={{width:'100%'}}>
                                <div style={{display:'flex',justifyContent:'space-between',fontSize:11,color:'var(--text-2)',marginBottom:4}}>
                                    <span>Прогресс оценок</span>
                                    <span style={{fontFamily:'var(--font-mono)'}}>{evalCount}/{MAX_EVALS}</span>
                                </div>
                                <div style={{background:'var(--surface-2)',borderRadius:4,height:6,overflow:'hidden'}}>
                                    <div style={{height:'100%', borderRadius:4, background: evalCount/MAX_EVALS > 0.8 ? 'var(--green)' : 'var(--accent)', width:`${Math.min(evalCount/MAX_EVALS*100,100)}%`, transition:'width 0.4s ease'}} />
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {/* Table */}
                <div className="table-wrap">
                    {isLoading ? (
                        <table>
                            <thead><tr><th>#</th><th>Статус</th><th>Направление</th><th>Телефон</th><th>Балл</th><th>Дата обращения</th><th>Дата оценки</th></tr></thead>
                            <tbody>
                                {[...Array(5)].map((_,i) => (
                                    <tr key={i}><td colSpan={7}><div style={{display:'grid',gridTemplateColumns:'40px 80px 1fr 120px 60px 140px 1fr',gap:8,padding:'12px 16px 12px 20px'}}>
                                        {[40,80,'1fr',120,60,140,'1fr'].map((w,j)=><div key={j} className="skeleton" style={{height:16,width:typeof w==='number'?w:'100%'}} />)}
                                    </div></td></tr>
                                ))}
                            </tbody>
                        </table>
                    ) : displayedCalls.length === 0 ? (
                        <div className="empty-state">
                            <div className="empty-state-icon"><i className="fas fa-inbox" /></div>
                            <h3>Нет оценок</h3>
                            <p>Нет данных за {months.find(m=>m.value===selectedMonth)?.label || selectedMonth}{selectedOperator ? ` для ${selectedOperator.name}` : ''}. Добавьте первую оценку.</p>
                        </div>
                    ) : (
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Статус</th>
                                    <th>Направление</th>
                                    <th>Телефон</th>
                                    <th>Балл</th>
                                    <th>Дата обращения</th>
                                    <th>Дата оценки / Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {displayedCalls.map((call, idx) => (
                                    <React.Fragment key={call.id}>
                                        <tr
                                            className={`${!call.is_imported ? 'clickable' : ''} ${call.is_imported ? 'imported' : ''} ${expandedId===call.id ? 'expanded' : ''}`}
                                            onClick={!call.is_imported ? () => handleSelectCall(call.id) : undefined}
                                        >
                                            <td>{idx+1}</td>
                                            <td>
                                                {loadingCallId === call.id ? (
                                                    <span style={{display:'flex',alignItems:'center',gap:6,fontSize:12,color:'var(--text-2)'}}>
                                                        <div style={{width:12,height:12,border:'2px solid var(--border-strong)',borderTopColor:'var(--accent)',borderRadius:'50%',animation:'spin 0.6s linear infinite'}} /> Загрузка
                                                    </span>
                                                ) : (
                                                    <span className={`badge ${call.is_imported ? 'badge-amber' : call.isDraft ? 'badge-blue' : 'badge-green'}`}>
                                                        <span className="badge-dot" />
                                                        {call.is_imported ? 'Не оценён' : call.isDraft ? 'Черновик' : 'Оценён'}
                                                    </span>
                                                )}
                                            </td>
                                            <td style={{color:'var(--text-2)'}}>{call.selectedDirection || '—'}</td>
                                            <td style={{fontFamily:'var(--font-mono)',fontSize:12}}>{call.phoneNumber || '—'}</td>
                                            <td>
                                                {call.totalScore != null ? (
                                                    <span className={`score-chip ${getScoreClass(call.totalScore)}`}>{Math.round(call.totalScore)}</span>
                                                ) : <span style={{color:'var(--text-3)'}}>—</span>}
                                            </td>
                                            <td style={{fontSize:12,color:'var(--text-2)'}}>{fmtDate(call.appeal_date)}</td>
                                            <td>
                                                <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',gap:8}}>
                                                    <span style={{fontSize:12,color:'var(--text-2)'}}>{fmtDate(call._rawEvaluation?.evaluation_date||call.date)}</span>
                                                    <div style={{display:'flex',alignItems:'center',gap:6,flexShrink:0}} onClick={e=>e.stopPropagation()}>
                                                        {call.is_imported ? (
                                                            <>
                                                                <button className="btn btn-green btn-sm" onClick={() => { setEditingEval(call); setShowEvalModal(true); }}><i className="fas fa-star" /> Оценить</button>
                                                                {userRole==='admin' && <button className="btn btn-danger btn-sm" onClick={() => deleteImportedCall(call.id)}><i className="fas fa-trash" /></button>}
                                                            </>
                                                        ) : (
                                                            <>
                                                                <SvRequestButton call={call} userId={userId} userRole={userRole} fetchEvaluations={fetchEvaluations} onReevaluate={() => { setEditingEval({...call,isReevaluation:true}); setShowEvalModal(true); }} />
                                                                {userRole==='admin' && !call.isDraft && (
                                                                    <>
                                                                        <button className="btn btn-secondary btn-sm" onClick={() => { setEditingEval({...call,isReevaluation:true}); setShowEvalModal(true); }}>
                                                                            <i className="fas fa-redo" /> Переоценить
                                                                        </button>
                                                                        {call.isCorrection && (
                                                                            <button className="btn btn-secondary btn-sm" onClick={async () => {
                                                                                try {
                                                                                    const r = await authFetch(`${API_BASE_URL}/api/call_versions/${call.id}`, {headers:{'X-User-Id':userId}});
                                                                                    const d = await r.json();
                                                                                    if (d.status==='success') { setVersionHistory(d.versions); setShowVersionsModal(true); }
                                                                                } catch(e) { console.error(e); }
                                                                            }}>
                                                                                <i className="fas fa-history" />
                                                                            </button>
                                                                        )}
                                                                    </>
                                                                )}
                                                            </>
                                                        )}
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>

                                        {/* Expanded row */}
                                        {expandedId === call.id && (
                                            <tr className="expanded-row">
                                                <td colSpan={7}>
                                                    <div className="expanded-content">
                                                        <h4>Детали оценки</h4>
                                                        <div className="expanded-meta">
                                                            <div className="expanded-meta-item"><strong>Оценщик:</strong> {call._rawEvaluation?.evaluator || '—'}</div>
                                                            <div className="expanded-meta-item"><strong>Дата оценки:</strong> {fmtDate(call._rawEvaluation?.evaluation_date||call.date)}</div>
                                                            <div className="expanded-meta-item"><strong>Дата обращения:</strong> {fmtDate(call._rawEvaluation?.appeal_date||call.appeal_date)}</div>
                                                        </div>
                                                        {call.audioUrl && call.directions?.[0]?.hasFileUpload && (
                                                            <div className="audio-wrap" style={{marginBottom:14,maxWidth:480}}>
                                                                <div className="audio-label">Аудиозапись</div>
                                                                <audio controls style={{width:'100%'}}><source src={call.audioUrl} type="audio/mpeg" /></audio>
                                                            </div>
                                                        )}
                                                        {call.directions?.[0]?.criteria?.length > 0 && (
                                                            <table className="crit-table">
                                                                <thead><tr><th>Критерий</th><th>Вес</th><th>Оценка</th><th>Комментарий</th></tr></thead>
                                                                <tbody>
                                                                    {call.directions[0].criteria.map((c, ci) => (
                                                                        <tr key={ci}>
                                                                            <td>{c.name}</td>
                                                                            <td style={{fontFamily:'var(--font-mono)',fontSize:12}}>{c.isCritical ? 'Крит.' : c.weight}</td>
                                                                            <td>
                                                                                <span className={call.scores[ci]==='Correct'||call.scores[ci]==='N/A' ? 'score-correct' : 'score-error'}>
                                                                                    {call.scores[ci] || 'Correct'}
                                                                                </span>
                                                                            </td>
                                                                            <td style={{color:'var(--text-2)',fontSize:12}}>{call.criterionComments?.[ci] || '—'}</td>
                                                                        </tr>
                                                                    ))}
                                                                </tbody>
                                                            </table>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        )}
                                    </React.Fragment>
                                ))}
                            </tbody>
                        </table>
                    )}
                </div>

                {/* Panel footer */}
                <div className="panel-footer">
                    <span className="panel-footer-info">
                        {selectedOperator ? `${displayedCalls.length} записей · ${selectedOperator.name} · ${months.find(m=>m.value===selectedMonth)?.label}` : 'Выберите оператора'}
                    </span>
                    <div style={{display:'flex',gap:8}}>
                        {userRole==='admin' && (viewMode==='extra'||hasExtra) && (
                            <button className="btn btn-secondary btn-sm" onClick={() => setViewMode(v=>v==='normal'?'extra':'normal')}>
                                <i className={`fas fa-${viewMode==='normal'?'filter':'list'}`} /> {viewMode==='normal' ? 'Доп. оценки' : 'Основные'}
                            </button>
                        )}
                        {viewMode === 'normal' && (
                            <button
                                className={`btn btn-primary btn-sm ${(!selectedOperator||isMaxReached) ? 'disabled' : ''}`}
                                style={{opacity:(!selectedOperator||isMaxReached)?0.4:1,cursor:(!selectedOperator||isMaxReached)?'not-allowed':'pointer'}}
                                onClick={() => { if (!selectedOperator||isMaxReached) return; setEditingEval(null); setShowEvalModal(true); }}
                                disabled={!selectedOperator||isMaxReached}
                            >
                                <i className="fas fa-plus" /> Добавить оценку
                            </button>
                        )}
                    </div>
                </div>
            </div>

            {/* Modals */}
            <LoginModal isOpen={showLoginModal} onLogin={handleLogin} />
            <EvaluationModal
                isOpen={showEvalModal}
                onClose={() => { setShowEvalModal(false); setEditingEval(null); }}
                onSubmit={handleEvaluateCall}
                directions={directions}
                operator={selectedOperator}
                selectedMonth={selectedMonth}
                userId={userId}
                userName={userName}
                existingEvaluation={editingEval}
            />

            {/* Version history modal */}
            {showVersionsModal && (
                <div className="modal-backdrop" onClick={() => setShowVersionsModal(false)}>
                    <div className="modal" style={{maxWidth:640}} onClick={e=>e.stopPropagation()}>
                        <div className="modal-header">
                            <div><h2>История версий</h2><div className="modal-header-sub">Все редакции данной оценки</div></div>
                            <button className="close-btn" onClick={() => setShowVersionsModal(false)}><i className="fas fa-times" /></button>
                        </div>
                        <div className="modal-body">
                            {versionHistory.map((v, i) => (
                                <div key={i} className="version-item">
                                    <div className="version-item-header">
                                        <span className="version-badge">Версия {versionHistory.length - i}</span>
                                        <span style={{fontSize:12,color:'var(--text-2)',fontFamily:'var(--font-mono)'}}>{v.evaluation_date?.split('T')[0]}</span>
                                    </div>
                                    <div className="version-grid">
                                        <div><strong>{v.score}</strong>Балл</div>
                                        <div><strong>{v.evaluator_name}</strong>Оценщик</div>
                                        <div><strong>{v.phone_number}</strong>Телефон</div>
                                        <div><strong>{v.month}</strong>Месяц</div>
                                        <div><strong>{v.appeal_date||'—'}</strong>Дата обращения</div>
                                    </div>
                                    {v.comment && <div style={{marginTop:10,fontSize:12,color:'var(--text-2)',padding:'8px',background:'var(--surface-2)',borderRadius:'var(--radius)'}}>{v.comment}</div>}
                                    {v.audio_path && <audio controls style={{width:'100%',marginTop:10}}><source src={v.audio_url||''} type="audio/mpeg" /></audio>}
                                </div>
                            ))}
                        </div>
                        <div className="modal-footer">
                            <button className="btn btn-secondary" onClick={() => setShowVersionsModal(false)}>Закрыть</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>